<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>ByteCode | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="需求之前版本的webentry需要判断每个.class文件（即对应的类上）是否被特定的annotation标记过（比如我们的@controller），若有，则用classloader加载；否则不管。
相关资料Java byteCode@wikiClass file format@oracle
123456789101112131415161718ClassFile &amp;#123;    u4">
<meta property="og:type" content="article">
<meta property="og:title" content="ByteCode">
<meta property="og:url" content="http://yoursite.com/2015/01/21/ByteCode/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="需求之前版本的webentry需要判断每个.class文件（即对应的类上）是否被特定的annotation标记过（比如我们的@controller），若有，则用classloader加载；否则不管。
相关资料Java byteCode@wikiClass file format@oracle
123456789101112131415161718ClassFile &amp;#123;    u4">
<meta property="og:updated_time" content="2017-03-30T10:31:08.501Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ByteCode">
<meta name="twitter:description" content="需求之前版本的webentry需要判断每个.class文件（即对应的类上）是否被特定的annotation标记过（比如我们的@controller），若有，则用classloader加载；否则不管。
相关资料Java byteCode@wikiClass file format@oracle
123456789101112131415161718ClassFile &amp;#123;    u4">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-ByteCode" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/01/21/ByteCode/" class="article-date">
  <time datetime="2015-01-20T16:00:00.000Z" itemprop="datePublished">2015-01-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/architecture/">architecture</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      ByteCode
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><p>之前版本的webentry需要判断每个.class文件（即对应的类上）是否被特定的annotation标记过（比如我们的@controller），若有，则用classloader加载；否则不管。</p>
<h3 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h3><p><a href="https://en.wikipedia.org/wiki/Java_bytecode" target="_blank" rel="external">Java byteCode@wiki</a><br><a href="http://docs.oracle.com/javase/specs/jvms/se7/html/jvms-4.html" target="_blank" rel="external">Class file format@oracle</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">ClassFile &#123;</div><div class="line">    u4             magic;</div><div class="line">    u2             minor_version;</div><div class="line">    u2             major_version;</div><div class="line">    u2             constant_pool_count;</div><div class="line">    cp_info        constant_pool[constant_pool_count-<span class="number">1</span>];</div><div class="line">    u2             access_flags;</div><div class="line">    u2             this_class;</div><div class="line">    u2             super_class;</div><div class="line">    u2             interfaces_count;</div><div class="line">    u2             interfaces[interfaces_count];</div><div class="line">    u2             fields_count;</div><div class="line">    field_info     fields[fields_count];</div><div class="line">    u2             methods_count;</div><div class="line">    method_info    methods[methods_count];</div><div class="line">    u2             attributes_count;</div><div class="line">    attribute_info attributes[attributes_count];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="方案①"><a href="#方案①" class="headerlink" title="方案①"></a>方案①</h3><p>也就是之前采用的方案，用的是spring封装的byteCode reader。该reader是基于ASM的简化版，实现的功能算是比较完善，满足spring的需求。</p>
<p>优点：功能完善，且经过spring的使用，稳定性、兼容性能有保证。<br>缺点：相对于我们的需求，该reader提供了很多我们实际上用不到的东西，必然要承受的代价就是要慢很多，甚至有可能慢上半个数量级。</p>
<h3 id="方案②"><a href="#方案②" class="headerlink" title="方案②"></a>方案②</h3><p>该方法是spring封装的reader的改进版。因为我们的需求非常简单，只需要找到.class（即该类）是否被特定的annotation标记过，那该.class的很多东西都不需要处理，比如fields，methods。因为我们的annotation属于RuntimeVisibleAnnotations，所以只需要在attribute里面去遍历，看是否包含有该annotation即可。</p>
<p>细节：class文件是用流式处理的，严格按照class format格式化的，读取的时候需要顺序读取。比如我们RuntimeVisibleAnnotations，定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">RuntimeVisibleAnnotations_attribute &#123;</div><div class="line">    u2         attribute_name_index;</div><div class="line">    u4         attribute_length;</div><div class="line">    u2         num_annotations;</div><div class="line">    annotation annotations[num_annotations];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对于每个annotation只能挨着去遍历，并且annotation里边的参数（key-value）也必须挨个读取。<br>我们的需求里面，不需要在这里处理参数，因此，不用真正的读取，只需要挨着跳过即可。</p>
<p>优点：简化了功能，只保留了我们需要用的功能，在本地测试，能减少50%左右的时间。<br>缺点：稳定性待验证。</p>
<h3 id="方案③"><a href="#方案③" class="headerlink" title="方案③"></a>方案③</h3><p>回顾我们的方案②，经过多次running，可以大概的把cost time分为如下图几部分：</p>
<p>$$\underbrace{\textrm{total time}}<em>\textrm{142 ms}  \Longrightarrow \begin{cases}<br> \underbrace{\textrm{part one}}</em>\textrm{86 ms}  \Longrightarrow<br>    \begin{cases}<br>        \underbrace{\textrm{read class(IO)}}<em>\textrm{29 ms} \<br>        \underbrace{\textrm{indexed constant pool}}</em>\textrm{3 ms} \<br>        alloc \ memory \ \&amp; \ other<br>    \end{cases}<br> \<br> \underbrace{\textrm{part two}}<em>\textrm{61 ms}  \Longrightarrow<br> \begin{cases}<br>        \underbrace{\textrm{skip method &amp; field}}</em>\textrm{2 ms} \<br>        \underbrace{\textrm{indexed constant pool}}_\textrm{56 ms} \<br>        other<br>    \end{cases}<br>\end{cases}$$</p>
<p>回到我们的需求，发现其实我们要的功能很简单，仅仅需要看他是否用了特定的annotation，而不关心更多东西，并且后面用classloader载入该.class。<br>因为在一个.class文件里，如果该class用到了一个类，那么，在它的constant pool里边一定会有这个类的引用。<br>所以，在indexed constant pool的时候，我们判断是否有该annotation的引用，如果有该annotation引用，那么很多情况下，这个.class是加上了这个annotation的（从class引用了该annotation，可以推出constant pool里边一定有该类的引用，是一个充分非必要条件，不能反推得出有该类的引用，则引用了该annotation）。</p>
<p>虽然该方案有缺陷，但是因为还有后边的反射做保证，所以，在兼顾性能的情况下，可以再省几近一半的时间，后面的测试也验证了该猜想。</p>
<p>大致的cost time分析：</p>
<p>$$\underbrace{\textrm{total time}}<em>\textrm{70 ms}  \Longrightarrow \begin{cases}<br>        \underbrace{\textrm{read class(IO)}}</em>\textrm{29 ms} \<br>        \underbrace{\textrm{indexed constant pool &amp; judge}}_\textrm{3 ms} \<br>        alloc \ memory \ \&amp; \ other<br>\end{cases}$$</p>
<p>当然，由于hotspot优化，这个时间不是特别的准，仅供参考。</p>
<h3 id="Benchmark"><a href="#Benchmark" class="headerlink" title="Benchmark"></a>Benchmark</h3><p>三次分别运行的结果</p>
<p>|spring tool Time(方案①)|333ms|319ms|323ms<br>|normal Time(方案②)|142ms|128ms|124ms<br>|tiny Time(方案③)|70ms|63ms|60ms<br>|IO TIme|29ms|25ms|26ms<br>|normal percentage|42%|40%|38%<br>|tiny percentage|21%|19%|18%</p>
<h3 id="待继续深入优化的地方"><a href="#待继续深入优化的地方" class="headerlink" title="待继续深入优化的地方"></a>待继续深入优化的地方</h3><p>首先考虑到的是读写文件，也就是IO的优化。目前用的是FileInputStream，每读一个字符，就会有一个系统调用。并且，现在使用的是把一个.class全部读入内存，并未对4k之类的问题进行考虑。如果将来瓶颈还在这块，可以考虑继续在这里优化。</p>
<h3 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h3><p>将kylin的所有Service（共19个）copy了50次（共953个），放在了同一文件夹下进行的模拟测试。</p>
<p>hotdog的测试结果与kylin的测试结果接近。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/01/21/ByteCode/" data-id="cj0w9kha00003a4skmxjowaev" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/03/18/LongAdder&LongAccumulator/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          LongAdder &amp; LongAccumulator
        
      </div>
    </a>
  
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/MongoDB/">MongoDB</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/architecture/">architecture</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/jdk-8/">jdk 8</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">January 2015</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/03/30/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2016/09/20/Contravariance & Covariance In Java Generics/">Contravariance &amp; Covariance in Java Generics</a>
          </li>
        
          <li>
            <a href="/2016/08/15/Reference type of volatile/">Reference type of volatile</a>
          </li>
        
          <li>
            <a href="/2016/05/24/MongoDB Tutorial ①安装及基本概念/">MongoDB Tutorial ①安装及基本概念</a>
          </li>
        
          <li>
            <a href="/2016/03/22/Striped64/">Striped64</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>