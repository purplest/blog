<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/blog/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/blog/css/main.css?v=6.6.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png?v=6.6.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png?v=6.6.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png?v=6.6.0">


  <link rel="mask-icon" href="/blog/images/logo.svg?v=6.6.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/blog/',
    scheme: 'Muse',
    version: '6.6.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="一些微小的记录">
<meta property="og:url" content="http://purplest.github.io/blog/index.html">
<meta property="og:site_name" content="一些微小的记录">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="一些微小的记录">






  <link rel="canonical" href="http://purplest.github.io/blog/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>一些微小的记录</title>
  











  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/blog/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">一些微小的记录</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/blog/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/blog/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://purplest.github.io/blog/blog/2018/12/03/View of Distributed Lock/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="purplest">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一些微小的记录">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/blog/blog/2018/12/03/View of Distributed Lock/" class="post-title-link" itemprop="http://purplest.github.io/blog/index.html">View of Distributed Lock</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-12-03 00:00:00" itemprop="dateCreated datePublished" datetime="2018-12-03T00:00:00+08:00">2018-12-03</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2018-12-04 13:22:13" itemprop="dateModified" datetime="2018-12-04T13:22:13+08:00">2018-12-04</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/blog/categories/Distributed-Lock/" itemprop="url" rel="index"><span itemprop="name">Distributed Lock</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>随着系统的不断发展，分布式锁是所有系统的一个永远绕不开的话题，那么，什么是分布式锁呢？它面临着什么问题？又分别是怎么去解决的呢？欢迎观看走近科学之——分布式锁。</p>
<h3 id="what-questions-in-distributed-system-we-must-faced"><a class="header-anchor" href="#what-questions-in-distributed-system-we-must-faced">¶</a>What questions in distributed system we must faced?</h3>
<p>要明白分布式锁是怎么回事，首先要明白我们现存的分布式系统。那么，分布式系统需要面临什么问题呢？为了便于理解，并且简化问题，我们先从单点系统开始，并扩展到分布式系统。</p>
<p>那么，我们首先看一下它们的异同：</p>
<table>
<thead>
<tr>
<th style="text-align:center">Questions</th>
<th style="text-align:center">Single node</th>
<th style="text-align:center">Distributed system</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Out of order</td>
<td style="text-align:center">Because of CPU</td>
<td style="text-align:center">Unreliable Network(delay, partition etc.)</td>
</tr>
<tr>
<td style="text-align:center">Knowledge&amp;Truth</td>
<td style="text-align:center">Atomic, consistency, visibility</td>
<td style="text-align:center">Defined by majority(GC, node outages)</td>
</tr>
<tr>
<td style="text-align:center">Clock</td>
<td style="text-align:center">-</td>
<td style="text-align:center">Quartz clock &amp; NTP</td>
</tr>
</tbody>
</table>
<p>首先，是order的问题。</p>
<p>在单点系统中，CPU和RAM是通过系统总线进行通信的。现代CPU为了提高执行效率，都会把指令乱序执行；不仅如此，编译器为了提高执行效率，也会根据不同的硬件、OS做不同的优化与适配，随之也会带来的并发的问题。然而，order是保证并发结果能够符合预期的基础，那么，有些什么手段能保证指令执行的order呢？</p>
<p>在各类高级语言中，一般来说都会存在编译器优化，即编译器级的乱序。但是为了保证执行顺序，一般高级语言都增加了各类关键字，以在对应代码块中禁用编译器乱序。例如在Java中，通过volatile关键词禁止了编译器的重排序。</p>
<p>那么，指令级别的重排序是如何禁用的呢？在Java中，答案也是volatile。在CPU指令级别上，JVM会在volatile修饰变量的前后，根据不同的CPU Architecture加上Memory Barriers，具体细节可以参考<a href="http://g.oswego.edu/dl/jmm/cookbook.html" target="_blank" rel="noopener">JSR-133</a><sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>。</p>
<p>在分布式系统中，我们不仅要处理单点系统中的乱序问题，还需要面对网络的问题。因为不同机器间通过以太网连接，一般来说都通过TCP or UDP等协议进行通信，即使像TCP之类的协议能保证传输过程中的有序性、可靠性，但并不是一个完全可靠的通信，随时都会有网络中断、拥塞之类的问题影响通信，丢包、乱序等问题的出现，甚至会导致网络分区等异常。</p>
<p>为了解决分布式环境下网络的不可靠性，分布式系统中通常需要一系列的机制去补偿这种不可靠性，当然，不同的可靠性都有不同的cost，我们需要做trade-off，去满足对应的需求。</p>
<hr>
<p>其次，我把他们统一称作Knowledge&amp;Truth。</p>
<p>在单点系统中，其实就是在并发的环境下，线程间临界区的可见性，以及竞争的问题。不同的高级语言都有不同的方式去保证，当然，这些工具的概念其实是相通的，例如：锁，原子类，信号量，cas等机制，都是为了解决这类问题的存在而创造出来的。</p>
<p>在分布式系统中，和之前一样，我们也会面临更多的问题，如GC类语言的STW问题、一系列潜在软硬件问题导致的某个节点不可用等问题，这些都是在分布式环境中需要考虑到的。因此，通常情况下，我们都会尽量去避免单点问题，因此，不可避免的会有各种各样的多活措施。</p>
<hr>
<p>最后，是时间的问题。一般来说，单点系统有影响，但在分布式环境下，是个很大的问题。因为普通计算机一般采用石英钟，但是石英钟会随着温度的变化而导致震动周期出现细微的变化。虽然通常情况下有NTP服务进行校准，但是系统时间的漂移，导致了系统的时间不可靠。当然也有部分方式去做一定的保证，比如<a href="https://lamport.azurewebsites.net/pubs/time-clocks.pdf" target="_blank" rel="noopener">Lamport clock</a><sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup>。</p>
<hr>
<p>通过问题的分析，我们可以看到，在分布式系统中，从最简单的没有任何保证的模型（当然也是最高效但可靠性最差的模型），到最严格的Linearizability（最可靠但必然会花费更高昂的代价），其实都是没有严格的对错的，all model is trade-off。</p>
<h3 id="how-to-solved"><a class="header-anchor" href="#how-to-solved">¶</a>How to solved?</h3>
<p>为了便于理解，我们先从单点系统出发，然后在扩展到分布式系统中。</p>
<h4 id="in-single-node"><a class="header-anchor" href="#in-single-node">¶</a>In single node</h4>
<p>为了尽量简洁的描述问题，就不再过多描述语言相关的问题，以及各种并发问题的细节。同时，也为了和当前通用的系统结合，我们在这里选择MySQL with InnoDB作为我们的单点系统描述对象，并且，MySQL提供的事务系统也是描述分布式锁的一个很好的范本。</p>
<h5 id="transaction"><a class="header-anchor" href="#transaction">¶</a>Transaction</h5>
<p>一谈到事务，就不得不提事务隔离级别。一般来说，MySQL提供了4个事务隔离级别，然而在更完备的学术文献中，一般是分为Weak Isolation levels和Actual Serial Execution两种，因此，接下来的描述中会和MySQL定义的事务隔离级别有些许出入。</p>
<h6 id="weak-isolation-levels"><a class="header-anchor" href="#weak-isolation-levels">¶</a>Weak Isolation levels:</h6>
<table>
<thead>
<tr>
<th style="text-align:center">Isolation level</th>
<th style="text-align:center">Sloved way</th>
<th style="text-align:center">Problem</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Read Uncommitted</td>
<td style="text-align:center">-</td>
<td style="text-align:center">Dirty read</td>
</tr>
<tr>
<td style="text-align:center">Read Committed</td>
<td style="text-align:center">Record lock</td>
<td style="text-align:center">Phantoms</td>
</tr>
<tr>
<td style="text-align:center">Snapshot Isolation</td>
<td style="text-align:center">MVCC-based</td>
<td style="text-align:center">Phantoms</td>
</tr>
</tbody>
</table>
<p>一般来说，Weak Isolation levels我们可以认为是Not Actual Serializability，也就是并不是能完全保证和序列化的执行的结果一致。</p>
<p>首先是Read Uncommitted。</p>
<p>这个是实现的最简单，甚至是简陋的方式，会有所有的并发问题。一般情况下也不会使用到该事务隔离级别。</p>
<hr>
<p>其次是Read Committed。</p>
<p>在实现中，一般是依靠Record lock来解决了Dirty read。其思路很简单，即使用类似ReadWriteLock的思路，可以并发读，但是读写互斥。然而，该事务隔离级别下，会有Phantoms。</p>
<hr>
<p>然后是Snapshot Isolation。</p>
<p>我们参考上一级事务隔离级别可以发现，读会和写互斥，但是在很多情况下，我们为了更好的性能，可以牺牲掉一定的数据一致性，例如：我们也许并不是很关心其他事务对该object修改成了什么值，它在当前修改之前对值已经足够使用。那么，有没有什么办法可以把这类读写给分离开呢？很显然，在InnoDB里已经有这类实现，即我们所知道的MVCC-based Snapshot Isolation。通过当前的transaction ID，去确定可见数据的version区间，从而显著的提高了系统的并发性能。当然，Phantoms依然存在。</p>
<hr>
<p>当然，这些都属于Weak Isolation level，因此，还需要其他的方式去达到Actual Serializability。</p>
<h6 id="actual-serial-execution"><a class="header-anchor" href="#actual-serial-execution">¶</a>Actual Serial Execution:</h6>
<table>
<thead>
<tr>
<th style="text-align:center">Model</th>
<th style="text-align:center">Implement in</th>
<th style="text-align:center">Automatically detecting lost update</th>
<th style="text-align:center">Concurrency Control Type</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">2PL(Two-Phase locking)</td>
<td style="text-align:center">MySQL with InnoDB</td>
<td style="text-align:center">Explicit with lock</td>
<td style="text-align:center">Pessimistic(Gap Lock)</td>
</tr>
<tr>
<td style="text-align:center">SSI(Serializable Snapshot Isolation)</td>
<td style="text-align:center">PostgreSQL(since 9.1)</td>
<td style="text-align:center">Yes</td>
<td style="text-align:center">Optimistic(Checked while commit)</td>
</tr>
</tbody>
</table>
<p>那么，主流的工业界实现分别用了什么办法去保证Actual Serializability呢？不同的工业界实现有不同的考虑。</p>
<p>2PL：</p>
<blockquote>
<p>According to the <a href="https://en.wikipedia.org/wiki/Two-phase_locking" target="_blank" rel="noopener"><strong>two-phase locking</strong></a><sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup> protocol, a transaction handles its locks in two distinct, consecutive phases during the transaction’s execution:</p>
<ol>
<li><strong>Expanding phase</strong> (aka Growing phase): locks are acquired and no locks are released (the number of locks can only increase).</li>
<li><strong>Shrinking phase</strong> (aka Contracting phase): locks are released and no locks are acquired.</li>
</ol>
</blockquote>
<p>具体到MySQL中，使用了2PL的方式，对于每个transaction来说，是这样的一个流程：</p>
<p><img src="https://purplest.github.io/blog/images/2pl.png" alt="2PL"></p>
<p>在InnoDB中，通过使用Gap lock，解决了之前提到的Phantoms的问题，很显然，这是一种Pessimistic concurrency control mechanism，在并发量比较轻的地方，如果锁实现的不够好，会有比较严重的性能问题，为了解决锁性能的问题，通常InnoDB会选择使用MVCC的实现方式，去达到了一个很好的性能平衡。</p>
<p>具体来说，对于snapshot read，很显然，能完全与写操作分离；对与current read，形如<code>SELECT ... FOR SHARE/UPDATE</code>的操作，仍然会对根据情况对record or gap进行加锁。</p>
<hr>
<p>SSI:</p>
<p>在2PL上，我们看到了MySQL的Pessimistic concurrency control mechanism，那对应的，有没有Optimistic concurrency control mechanism呢？答案是显然的。在SIGMOD‘08上有这么一篇paper：<a href="https://courses.cs.washington.edu/courses/cse444/08au/544M/READING-LIST/fekete-sigmod2008.pdf" target="_blank" rel="noopener">Serializable Isolation for Snapshot Databases</a><sup class="footnote-ref"><a href="#fn4" id="fnref4">[4]</a></sup>，提出了Serializable Snapshot Isolation的思路，那么，有没有实践呢？同样的，在VLDB2012上有这么一篇paper：<a href="https://drkp.net/papers/ssi-vldb12.pdf" target="_blank" rel="noopener">Serializable Snapshot Isolation in PostgreSQL</a><sup class="footnote-ref"><a href="#fn5" id="fnref5">[5]</a></sup>，当然，<a href="https://wiki.postgresql.org/wiki/SSI" target="_blank" rel="noopener">PostgreSQL’s wiki</a><sup class="footnote-ref"><a href="#fn6" id="fnref6">[6]</a></sup>里也详细介绍了这种实现方式的具体细节。简而言之，就像乐观锁之于悲观锁一样，SSI提供了stale data的检测机制（transaction ID），在commit transaction的时候，如果有stale data，DB则会abort当前的transaction。</p>
<h5 id="additional-problem"><a class="header-anchor" href="#additional-problem">¶</a>Additional problem:</h5>
<p>在明白所有的concurrency control mechanism后，我们再来看看在实践中的使用。</p>
<h6 id="cas"><a class="header-anchor" href="#cas">¶</a>CAS?</h6>
<p>因为SSI走的是另一套detecting逻辑，因此，我们仅考虑2PL会存在的问题。</p>
<p>首先假设使用场景是MySQL with InnoDB，事务隔离级别为MySQL的Repeatable Read。那么，我们的CAS一般有两种方式：<code>立即写</code>与<code>延迟写</code>。</p>
<hr>
<p>我们首先看第一种场景，<code>立即写</code>。这种场景下，我们有一张progress的表，id为主键，status代表状态，我们的SQL大概会这么写：</p>
<blockquote>
<p>UPDATE progress SET status=2 WHERE id = 5 AND status = 1;</p>
</blockquote>
<p>因为update为write，自带current read，因此这种CAS的方式要么成功，要么失败（transaction保证），不会有其他的问题。但是这种场景有局限性，如果需要对status做更多的处理呢？</p>
<hr>
<p>那么，第二种场景，也就是<code>延迟写</code>便呼之欲出了，类似于场景一，只不过我们需要做更多的逻辑操作：</p>
<blockquote>
<p>SELECT status FROM progress where id = 5;</p>
<p>…</p>
<p>do some logic</p>
<p>…</p>
<p>UPDATE progress SET status=2 WHERE id = 5;</p>
</blockquote>
<p>那么，这样有没有什么问题呢？在MySQL下，这样做会有并发问题，因为第一个的<code>SELECT</code>为snapshot read。那么，有没有办法避免这种问题呢？其实，解决的办法就是刚才提到的Automatically detecting lost update的问题，在2PL中，需要一个Explicit lock，具体到这个case，仅需把第一个<code>SELECT</code>改为<code>SELECT ... FOR UPDATE</code>的形式即可。</p>
<hr>
<p>至此我们基本理解了在single node下如何做到Serializability，这将是连接分布式系统的桥梁。</p>
<h4 id="in-distributed-system"><a class="header-anchor" href="#in-distributed-system">¶</a>In Distributed System</h4>
<p>那么，我们将眼光放到分布式系统中。为了便于理解，我们首先看一看redis。</p>
<p>redis是一个单线程的实现，对接收到的数据会顺序处理，通常用于cache。虽然单线程模型会有一定的性能问题，但单线程执行接收到的命令天然保证了order的特性（网络环境导致的delay等问题不在此讨论），特别是支持lua脚本扩展，极大的扩展了使用场景。</p>
<p>为了让集群更鲁棒，通常我们会使用redis的集群模式。目前来看，redis的集群模式分别有官方实现的Sentinel和Gossip，以及第三方实现的codis，但不管用哪种集群模式，因为redis设计之初的定位，在速度与可靠性上选择了极致的速度，舍弃了很多一致性的保证，因此，aof异步同步方式并不一定能保证完全可靠，数据一致性有时候也会看缘分。</p>
<h5 id="implement-distributed-lock-using-redis"><a class="header-anchor" href="#implement-distributed-lock-using-redis">¶</a>Implement distributed lock using redis:</h5>
<p>一般来说，用redis实现一个分布式锁有大概三种方式，Simplicity type、Safe-unlock type和Redlock。</p>
<hr>
<h6 id="simplicity-type："><a class="header-anchor" href="#simplicity-type：">¶</a>Simplicity type：</h6>
<p>最朴素的版本非常简单，可以直接SETNX命令即可实现lock：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET lock_key random_value NX PX expire_time</span><br></pre></td></tr></table></figure>
<p>那么，在unlock的时候可以直接使用DEL：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DEL lock_key</span><br></pre></td></tr></table></figure>
<p>那这样就OK了么？有没有什么问题呢？我们考虑一下这样的case：</p>
<p><img src="https://purplest.github.io/blog/images/redis.png" alt="redis"></p>
<p>如图，假设session A通过lock拿到锁以后，就去执行相应的业务逻辑。当然，同步调用一旦被阻塞，可能会导致key超时。那么，当session A超时以后，自然session B即可获取到锁。在session B拿到锁以后，session A从阻塞中唤醒，直接去通过del的方式unlock key就会导致锁的错误释放问题。那错误的unlock有办法解决么？</p>
<hr>
<h6 id="safe-unlock-type："><a class="header-anchor" href="#safe-unlock-type：">¶</a>Safe-unlock type：</h6>
<p>答案是肯定的，这个问题的关键是，在unlock的时候，不知道是谁持有这个锁，那我们想一个办法去标志lock的持有者，问题是不是就解决了呢？对应的lock：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET lock_key owner_value NX PX expire_time</span><br></pre></td></tr></table></figure>
<p>我们把value从之前的随机值，替换为了标志当前session的一个唯一标志符，那么，在unlock的时候也需要一起做判断：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if redis.call("get",KEYS[1]) == ARGV[1] then</span><br><span class="line">    return redis.call("del",KEYS[1])</span><br><span class="line">else</span><br><span class="line">    return 0</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>在unlock的时候比上一种有了变化，我们需要去对当前的value做判断：如果value是当前session，那就可以安全的unlock；如果value不是当前的session，则认为是自己超时，并且返回0值，这样，我们即可在程序里判断是哪种情况。这里为了让该CAS操作具有原子性，所以需要用lua的支持。</p>
<p>但是，这样的分布式锁就一定可靠么？显然，结论是否定的，那么有没有更优雅并且更可靠的方式呢？</p>
<hr>
<h6 id="redlock"><a class="header-anchor" href="#redlock">¶</a><a href="https://redis.io/topics/distlock" target="_blank" rel="noopener">Redlock</a><sup class="footnote-ref"><a href="#fn7" id="fnref7">[7]</a></sup></h6>
<p>redis的作者参考了现有的一些方式，提出了一种RedLock的实现，其本质上和用于LeaderLess的Quorum NWR思路基本一致：</p>
<blockquote>
<p>In the distributed version of the algorithm we assume we have N Redis masters. Those nodes are totally independent, so we don’t use replication or any other implicit coordination system. We already described how to acquire and release the lock safely in a single instance. We take for granted that the algorithm will use this method to acquire and release the lock in a single instance. In our examples we set N=5, which is a reasonable value, so we need to run 5 Redis masters on different computers or virtual machines in order to ensure that they’ll fail in a mostly independent way.</p>
<p>In order to acquire the lock, the client performs the following operations:</p>
<ol>
<li>It gets the current time in milliseconds.</li>
<li>It tries to acquire the lock in all the N instances sequentially, using the same key name and random value in all the instances. During step 2, when setting the lock in each instance, the client uses a timeout which is small compared to the total lock auto-release time in order to acquire it. For example if the auto-release time is 10 seconds, the timeout could be in the ~ 5-50 milliseconds range. This prevents the client from remaining blocked for a long time trying to talk with a Redis node which is down: if an instance is not available, we should try to talk with the next instance ASAP.</li>
<li>The client computes how much time elapsed in order to acquire the lock, by subtracting from the current time the timestamp obtained in step 1. If and only if the client was able to acquire the lock in the majority of the instances (at least 3), and the total time elapsed to acquire the lock is less than lock validity time, the lock is considered to be acquired.</li>
<li>If the lock was acquired, its validity time is considered to be the initial validity time minus the time elapsed, as computed in step 3.</li>
<li>If the client failed to acquire the lock for some reason (either it was not able to lock N/2+1 instances or the validity time is negative), it will try to unlock all the instances (even the instances it believed it was not able to lock).</li>
</ol>
</blockquote>
<p>简单来概括一下，首先选择N台redis集群，author给了个例子，这里N=5。每次通过以下步骤来aquire lock：</p>
<ol>
<li>获取当前时间</li>
<li>对N个instance依次（sequentially）aquire lock，方式和Safe-unlock type类似。为了尽可能快（ASAP）的获取所有节点的锁，给每个aquire lock的操作设置一个很短的超时时间（For example if the auto-release time is 10 seconds, the timeout could be in the ~ 5-50 milliseconds range.），目的是为了避免某个节点不可用而让之前获取到的锁因为等待超时。</li>
<li>同NWR的思路一样，当且仅当获得3个以上instance的确认，并且从step1到当前时间小于锁超时时间，这才认为获取到了这个分布式锁。</li>
<li>当前获取到锁的有效时间=（锁超时时间-获取锁花费的时间）。</li>
<li>如果某个client因为某些原因（不管是当前时间大于锁超时时间，还是不能获取3台及以上instance的锁）不能获取锁，那么应该去把持有的锁释放。</li>
</ol>
<p>这个思路比较长，细节也不少，最终的目的都是为了尽可能快的在不同机器上增加一个锁标志，而对于失败的client则尽快去释放持有的资源。</p>
<p>那么，这个方法能够真正的满足我们对分布式锁的可靠性要求么？我们回到开头，分布式系统存在的问题里依次去分析：</p>
<p>首先是网络问题，包括但不限于delay，partition。对于delay的问题，靠redis instance的接收顺序来保证，但是对与严重的delay，或者partition来说，超时、丢包等问题会非常严重，但Redlock是依次（sequentially）去aquire lock，同步的去获取，虽然有超时时间的限制。</p>
<p>其次是可见性的问题，最根本的原因还是redis master与slaver之间是依靠异步的方式，而丢数据的问题是不可避免的，并且，slaver什么时候能看到master的写入数据，完全看缘分。</p>
<p>最后，是clock的问题。 从上面的细节可以看到，redlock高度依赖clock，但是对于系统时间的瞬间变动，redlock基本毫无解决的办法。更完善的分析可以参考<a href="http://martin.kleppmann.com/2016/02/08/how-to-do-distributed-locking.html" target="_blank" rel="noopener">Martin的blog</a><sup class="footnote-ref"><a href="#fn8" id="fnref8">[8]</a></sup>。</p>
<hr>
<p>我们跳出这个问题，回到redis的设计思路，其本质还是在可靠性与速度之间，选择了速度，因此，即便是做了一系列的补偿，也掩盖不了顶层设计思路的局限性。相对于Safe-unlock type来说，redlock做的一系列补偿基本依靠NWR的多备份一定程度的提高了可用性，相对于Safe-unlock type来说，提高很有限，但却显著的增加了复杂度，并且，还依赖了不可靠的clock。</p>
<p>那么，我们还有可靠性更高的方案么？</p>
<h5 id="linearizability"><a class="header-anchor" href="#linearizability">¶</a><a href="https://en.wikipedia.org/wiki/Linearizability" target="_blank" rel="noopener">Linearizability</a><sup class="footnote-ref"><a href="#fn9" id="fnref9">[9]</a></sup>:</h5>
<p>要了解高可用，那就不得不了解一致性；要了解一致性，那就不得不了解Linearizability。</p>
<p>那什么是Linearizability呢？</p>
<blockquote>
<p>In <a href="https://en.wikipedia.org/wiki/Concurrent_programming" target="_blank" rel="noopener">concurrent programming</a>, an operation (or set of operations) is <strong>linearizable</strong> if consists of an ordered list of invocation and response events(<a href="https://en.wikipedia.org/wiki/Callbacks" target="_blank" rel="noopener">callbacks</a>), that may be extended by adding response events such that:</p>
<ol>
<li>The extended list can be re-expressed as a sequential history(is <a href="https://en.wikipedia.org/wiki/Serializability" target="_blank" rel="noopener">serializable</a>), and</li>
<li>That sequential history is a subset of the original unextended list.</li>
</ol>
</blockquote>
<p>一句话来说的话，不管是对读还是写来说，Linearizability描述了一种读写的顺序。简单来说，如果对于client A写入了a=6，如果client B看到了a=6，那client C一定也能看到a=6。这里看起来有点像serializability，那么他和serializability有什么区别呢？</p>
<p>对serializability来说，保证的是并发环境下的读写「看起来像」是在单线程执行，他面向的是一个transaction，会涉及到多个变量（对象）。如之前snapshot isolation里说的，因为old version的存在，是允许看到old version的数据的，这个并未违反serializability，他仅仅限定了最终结果和单线程执行一样。</p>
<p>对Linearizability来说，保证的是「一旦某位observer看到了某个结果，那其他observer也一定能看到」，例如刚才的例子「client B看到了a=6，那client C一定也能看到a=6」，所以，Linearizability也被称作Consensus，也就是共识。</p>
<p>我们可以从一张图完整的看清他们的区别与联系：</p>
<p><img src="http://martin.kleppmann.com/2014/11/isolation-levels.png" alt="Hierarchy of isolation levels"></p>
<p>1SR = serializability, RR = repeatable read, SI = snapshot isolation, RC = read committed.</p>
<p>当然，更多细节参考这篇VLDB的paper：<a href="http://arxiv.org/pdf/1302.0309.pdf" target="_blank" rel="noopener">Highly Available Transactions: Virtues and Limitations</a><sup class="footnote-ref"><a href="#fn10" id="fnref10">[10]</a></sup></p>
<h5 id="raft"><a class="header-anchor" href="#raft">¶</a><a href="https://en.wikipedia.org/wiki/Raft_(computer_science)" target="_blank" rel="noopener">raft</a><sup class="footnote-ref"><a href="#fn11" id="fnref11">[11]</a></sup>:</h5>
<p>那么，有什么方式能保证Linearizability呢？答案很多，从最初的Paxos，到multi-Paxos，raft等。</p>
<p>为了降低理解成本，这里选择从raft切入。</p>
<hr>
<p>raft是single-leader replication模型，依靠一个（one and only one）选举出来的leader来做到Linearizability。</p>
<p>raft的节点一共有三种角色：leader，follower和candidate。集群会在启动的时候做选举，即<code>Leader Election</code>，当确定一个leader以后，即可对外提供服务。为了满足Linearizability，所有的请求（raft里称作<code>entry</code>），都会由leader来处理，并与follower同步，这个处理方式被称作<code>Log Replication</code>。</p>
<h6 id="leader-election："><a class="header-anchor" href="#leader-election：">¶</a>Leader Election：</h6>
<p>在集群启动的时候，或者leader不可用的时候，节点就会切换到candidate的状态。处于candidate的节点首先会对term+1，对自己voting的同时，向其他节点发起vote（vote中会包含当前term）。每candidate在每一个term里，采取first-come-first-served的方式，只voting一个candidate。</p>
<p>一旦某个candidate收到一个vote，并且这个vote的term比自己的term大，该candidate就会放弃本轮竞选，voting该node，并且从candidate转变成follower。</p>
<p>一旦某个candidate收到过半的认同vote，该candidate则会变成leader；如果当前term有分歧，即没选出leader，则会启动下一term的voting。</p>
<p>为了保证leader Election一定能出结果，raft在启动/重选举的时候增加了一个很小的随机时间。</p>
<p><a href="https://raft.github.io/raftscope/index.html" target="_blank" rel="noopener">voting的可视化过程</a></p>
<h6 id="log-replication："><a class="header-anchor" href="#log-replication：">¶</a>Log Replication：</h6>
<p>当leader收到请求以后，便会生成一个新的<code>entry</code>，在状态机（replicated state machines）中执行，并向follower发送被称作<code>AppendEntries</code>的消息。follower在收到消息后，和leader类似，先执行并确认当前entry。当leader接收到过半的确认以后，便会commit这个entry。</p>
<p>我们可以从中看到，raft是按照顺序对entry进行commit的，也就是说，当编号为T的entry被commit以后，蕴含着从0，1，到T-1，T的entry都已被commit。这种机制也是保证raft数据一致性的保证之一。</p>
<h5 id="zookeeper："><a class="header-anchor" href="#zookeeper：">¶</a>zookeeper：</h5>
<p>那么，raft有没有什么开源的实现呢？答案是显然的，zookeeper的一致性是依赖Zab（Zookeeper Atomic Broadcast）协议，与raft有些许差异，但主体逻辑基本一致（不一致的地方可以参考<a href="https://cwiki.apache.org/confluence/display/ZOOKEEPER/Zab+vs.+Paxos" target="_blank" rel="noopener">Zab.vs.Paxos</a><sup class="footnote-ref"><a href="#fn11" id="fnref11:1">[11]</a></sup>）。以下是leader执行写操作的过程，leader会收到过半follower的ACK以后，才会commit proposal。</p>
<p><img src="https://purplest.gitbooks.io/zookeeper-source-code/content/assets/cccccc.png" alt="img"></p>
<p>接着，我们了解zookeeper里的三个概念：<code>Sequence Nodes</code>，<code>Ephemeral Nodes</code>和<code>watchs</code>。</p>
<h6 id="sequence-nodes："><a class="header-anchor" href="#sequence-nodes：">¶</a>Sequence Nodes：</h6>
<blockquote>
<p>When creating a znode you can also request that ZooKeeper append a monotonically increasing counter to the end of path. This counter is unique to the parent znode. The counter has a format of %010d – that is 10 digits with 0 (zero) padding (the counter is formatted in this way to simplify sorting), i.e. “<path>0000000001”. See <a href="https://zookeeper.apache.org/doc/current/recipes.html#sc_recipes_Queues" target="_blank" rel="noopener">Queue Recipe</a> for an example use of this feature. Note: the counter used to store the next sequence number is a signed int (4bytes) maintained by the parent node, the counter will overflow when incremented beyond 2147483647 (resulting in a name “<path>-2147483648”).</path></path></p>
</blockquote>
<p>简单来说，就是zookeeper的单调递增计数器（monotonically increasing counter），通过Zab协议保证。</p>
<h6 id="ephemeral-nodes："><a class="header-anchor" href="#ephemeral-nodes：">¶</a>Ephemeral Nodes：</h6>
<blockquote>
<p>ZooKeeper also has the notion of ephemeral nodes. These znodes exists as long as the session that created the znode is active. When the session ends the znode is deleted. Because of this behavior ephemeral znodes are not allowed to have children.</p>
</blockquote>
<p>临时节点故如其名，每个client会与znode建立session，一旦session断开，当前session创建的ephemeral nodes就会被销毁。</p>
<h6 id="watches："><a class="header-anchor" href="#watches：">¶</a>Watches：</h6>
<blockquote>
<p>Clients can set watches on znodes. Changes to that znode trigger the watch and then clear the watch. When a watch triggers, ZooKeeper sends the client a notification. More information about watches can be found in the section <a href="https://zookeeper.apache.org/doc/current/zookeeperProgrammers.html#ch_zkWatches" target="_blank" rel="noopener">ZooKeeper Watches</a>.</p>
</blockquote>
<p>zookeeper支持在对应的znode上注册一个watcher，当注册的事件发生的时候，znode就会通知对应的client。</p>
<hr>
<p>那么，我们如何利用zookeeper来做分布式锁呢？</p>
<blockquote>
<p>Clients wishing to obtain a lock do the following:</p>
<ol>
<li>Call <strong>create( )</strong> with a pathname of “<em>locknode</em>/lock-” and the <em>sequence</em> and <em>ephemeral</em> flags set.</li>
<li>Call <strong>getChildren( )</strong> on the lock node <em>without</em> setting the watch flag (this is important to avoid the herd effect).</li>
<li>If the pathname created in step <strong>1</strong> has the lowest sequence number suffix, the client has the lock and the client exits the protocol.</li>
<li>The client calls <strong>exists( )</strong> with the watch flag set on the path in the lock directory with the next lowest sequence number.</li>
<li>if <strong>exists( )</strong> returns false, go to step <strong>2</strong>. Otherwise, wait for a notification for the pathname from the previous step before going to step <strong>2</strong>.</li>
</ol>
<p><a href="https://zookeeper.apache.org/doc/r3.3.2/recipes.html" target="_blank" rel="noopener">from Apache</a><sup class="footnote-ref"><a href="#fn12" id="fnref12">[12]</a></sup></p>
</blockquote>
<p>简单来说，总体思路和redis上Safe-unlock type的思路基本一致，但利用上面提到的三个概念，使client对锁对掌控更有力。</p>
<ol>
<li>首先，调用 <strong>create( )</strong> 在对应对pathname下创建类似于「locknode_/lock-」的Sequence ephemeral node。</li>
<li>再调用 <strong>getChildren( )</strong> 查看节点下对应的node，为了避免「herd effect」，这里不能加watcher。</li>
<li>如果在step.1中创建的节点为序号最低的节点，那就认为已经拿到了锁，并且结束lock操作。</li>
<li>否则，通过调用<strong>exists( )</strong>，并设置watcher。</li>
<li>如果<strong>exists( )</strong> 返回false（即刚才拿到锁的client释放了锁），那么回到step.2重新去获取锁。否则，依靠watcher事件唤醒，再去step.2重新获取锁。</li>
</ol>
<hr>
<h5 id="one-more-things："><a class="header-anchor" href="#one-more-things：">¶</a>One more things：</h5>
<p>其实这里会有一个问题，在现有的工业界中，zookeeper是唯一的终极解决方案么？显然不是的。可能在大家的共识里，zookeeper是Google Chubby的一个开源实现，然而，俩者的差距从实现思路上就有了本质的区别：</p>
<blockquote>
<ul>
<li><strong>Chubby</strong>：provide coarse-grained locking as well as reliable storage for a loosely-coupled distributed system.</li>
<li><strong>Zookeeper</strong>：provide a simple and high performance kernel for building more complex coordination primitives at the client.</li>
</ul>
</blockquote>
<p>Chubby是为了分布式锁而设计，是paxos的一个实现，提供了Linearizability。而zookeeper是在paxos的基础上简化了状态，强化了leader，但只提供了写入的Linearizability。具体细节可以参考Chubby的paper：<a href="https://static.googleusercontent.com/media/research.google.com/zh-CN//archive/chubby-osdi06.pdf" target="_blank" rel="noopener">The Chubby lock service for loosely-coupled distributed systems</a><sup class="footnote-ref"><a href="#fn13" id="fnref13">[13]</a></sup>。</p>
<p>除此之外，类似于etcd等方案也逐渐成为了业界的主流，TiDB等分布式一致性数据库也在不断的发展，PolarFS甚至提出了ParallelRaft（<a href="http://www.vldb.org/pvldb/vol11/p1849-cao.pdf" target="_blank" rel="noopener">PolarFS- An Ultra-low Latency and Failure Resilient Distributed File System for Shared Storage Cloud Database</a><sup class="footnote-ref"><a href="#fn14" id="fnref14">[14]</a></sup>），但其本质，可以认为大致相似。</p>
<h3 id="conclusion："><a class="header-anchor" href="#conclusion：">¶</a>conclusion：</h3>
<p>至此，已经对常用的分布式锁作了一个比较简单但完整的总结。我们可以看到，在单点系统中，用MySQL作为例子，介绍了常用的处理并发的方式，并以此为基础，将问题推广到了分布式系统。当然，分布式系统中的问题并没有想象中那么简单，我们可以简单的分为unreliability和Linearizability。</p>
<h5 id="unreliability："><a class="header-anchor" href="#unreliability：">¶</a>unreliability：</h5>
<p>以redis为代表各类分布式锁的实现均归为此类。因为没有对分布式问题完备的处理方式，在特殊的环境下会出现严重的一致性、可用性等问题，但问题的本质在于，redis的实现本来就是一个牺牲一致性保证性能的trade-off，因此，在使用中通常用于做好了幂等性，并且允许重复调用、允许执行丢失等不太在意高可用的环境。</p>
<h5 id="linearizability："><a class="header-anchor" href="#linearizability：">¶</a>Linearizability：</h5>
<p>以paxos、raft等一致性保证的方式均归位此类。因为考虑了分布式环境的各类问题，并做好了容错与冗余。但由于设计思路为牺牲性能保证一致性与可用性，因此，性能方面可能有一定的劣势。</p>
<p>参考文献</p>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p><a href="http://g.oswego.edu/dl/jmm/cookbook.html" target="_blank" rel="noopener">http://g.oswego.edu/dl/jmm/cookbook.html</a>	“The JSR-133 Cookbook for Compiler Writers” <a href="#fnref1" class="footnote-backref">↩</a></p>
</li>
<li id="fn2" class="footnote-item"><p><a href="https://lamport.azurewebsites.net/pubs/time-clocks.pdf" target="_blank" rel="noopener">https://lamport.azurewebsites.net/pubs/time-clocks.pdf</a>	“Time, Clocks, and the Ordering of Events in a Distributed System” <a href="#fnref2" class="footnote-backref">↩</a></p>
</li>
<li id="fn3" class="footnote-item"><p><a href="https://en.wikipedia.org/wiki/Two-phase_locking" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Two-phase_locking</a>	“Two-phase locking” <a href="#fnref3" class="footnote-backref">↩</a></p>
</li>
<li id="fn4" class="footnote-item"><p><a href="https://courses.cs.washington.edu/courses/cse444/08au/544M/READING-LIST/fekete-sigmod2008.pdf" target="_blank" rel="noopener">https://courses.cs.washington.edu/courses/cse444/08au/544M/READING-LIST/fekete-sigmod2008.pdf</a>	“Serializable Isolation for Snapshot Databases” <a href="#fnref4" class="footnote-backref">↩</a></p>
</li>
<li id="fn5" class="footnote-item"><p><a href="https://drkp.net/papers/ssi-vldb12.pdf" target="_blank" rel="noopener">https://drkp.net/papers/ssi-vldb12.pdf</a>	“Serializable Snapshot Isolation in PostgreSQL” <a href="#fnref5" class="footnote-backref">↩</a></p>
</li>
<li id="fn6" class="footnote-item"><p><a href="https://wiki.postgresql.org/wiki/SSI" target="_blank" rel="noopener">https://wiki.postgresql.org/wiki/SSI</a>	“Serializable Snapshot Isolation (SSI) in PostgreSQL” <a href="#fnref6" class="footnote-backref">↩</a></p>
</li>
<li id="fn7" class="footnote-item"><p><a href="https://redis.io/topics/distlock" target="_blank" rel="noopener">https://redis.io/topics/distlock</a>	“Distributed locks with Redis” <a href="#fnref7" class="footnote-backref">↩</a></p>
</li>
<li id="fn8" class="footnote-item"><p><a href="http://martin.kleppmann.com/2016/02/08/how-to-do-distributed-locking.html" target="_blank" rel="noopener">http://martin.kleppmann.com/2016/02/08/how-to-do-distributed-locking.html</a>	“How to do distributed locking” <a href="#fnref8" class="footnote-backref">↩</a></p>
</li>
<li id="fn9" class="footnote-item"><p><a href="https://en.wikipedia.org/wiki/Linearizability" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Linearizability</a>	“Linearizability” <a href="#fnref9" class="footnote-backref">↩</a></p>
</li>
<li id="fn10" class="footnote-item"><p><a href="http://arxiv.org/pdf/1302.0309.pdf" target="_blank" rel="noopener">http://arxiv.org/pdf/1302.0309.pdf</a>	“Highly Available Transactions: Virtues and Limitations” <a href="#fnref10" class="footnote-backref">↩</a></p>
</li>
<li id="fn11" class="footnote-item"><p><a href="https://en.wikipedia.org/wiki/Raft_(computer_science)" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Raft_(computer_science)</a>	“Raft” <a href="#fnref11" class="footnote-backref">↩</a> <a href="#fnref11:1" class="footnote-backref">↩</a></p>
</li>
<li id="fn12" class="footnote-item"><p><a href="https://zookeeper.apache.org/doc/r3.3.2/recipes.html" target="_blank" rel="noopener">https://zookeeper.apache.org/doc/r3.3.2/recipes.html</a>	“ZooKeeper Recipes and Solutions” <a href="#fnref12" class="footnote-backref">↩</a></p>
</li>
<li id="fn13" class="footnote-item"><p><a href="https://static.googleusercontent.com/media/research.google.com/zh-CN//archive/chubby-osdi06.pdf" target="_blank" rel="noopener">https://static.googleusercontent.com/media/research.google.com/zh-CN//archive/chubby-osdi06.pdf</a>	“The Chubby lock service for loosely-coupled distributed systems” <a href="#fnref13" class="footnote-backref">↩</a></p>
</li>
<li id="fn14" class="footnote-item"><p><a href="http://www.vldb.org/pvldb/vol11/p1849-cao.pdf" target="_blank" rel="noopener">http://www.vldb.org/pvldb/vol11/p1849-cao.pdf</a>	“PolarFS- An Ultra-low Latency and Failure Resilient Distributed File System for Shared Storage Cloud Database” <a href="#fnref14" class="footnote-backref">↩</a></p>
</li>
</ol>
</section>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://purplest.github.io/blog/blog/2018/08/05/一个诡异的MySQL慢查询问题复盘/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="purplest">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一些微小的记录">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/blog/blog/2018/08/05/一个诡异的MySQL慢查询问题复盘/" class="post-title-link" itemprop="http://purplest.github.io/blog/index.html">一个诡异的MySQL慢查询问题复盘</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-08-05 00:00:00 / Modified: 00:08:35" itemprop="dateCreated datePublished" datetime="2018-08-05T00:00:00+08:00">2018-08-05</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/blog/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="起因"><a class="header-anchor" href="#起因">¶</a>起因</h3>
<p>在周五的下午，群里接到反馈，在生产坏境的MySQL实例上有大量的慢查询，导致了大面积的熔断，部分线上业务受影响。</p>
<p>MySQL的慢查询见多了，Google一下就是一大票，无非也就是没走索引/SQL写的太烂/各种乱嵌套blablabla，因为不是自己负责的业务，手头正好也有别的事儿，就没太在意，继续去忙了……</p>
<p>然而，还是太图样图森破，忙完后一看群，发现慢查询的问题还没找出来，只是初步定位到了是一个join导致的，瞬间就被激发出了兴趣（当然也一起被带进了坑里），找同事要到了对应的SQL，发现SQL异常的简单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">select</span><br><span class="line">  c.c_code as cCode,</span><br><span class="line">  u.u_code as uCode,</span><br><span class="line">  h.h_code as hCode</span><br><span class="line">from c</span><br><span class="line">join u on c.u_code = u.u_code</span><br><span class="line">join h on u.h_code = h.h_code</span><br><span class="line"> WHERE c.c_code = &apos;xxxxxxxxxxxxx&apos;;</span><br></pre></td></tr></table></figure>
<p>这么样的SQL会有慢查询？线上跑了这么久的代码会没加索引？看来，事情没有想象的那么简单呐。问同事了解了table的结构后，瞬间傻眼了：c_code、u_code、h_code分别是c、u、h表的一个unique index，这样的SQL能有哪门子的慢查询啊，这还是我认识的MySQL么？简直颠覆了我对MySQL的认知……必须查出到底啥原因，否则真是白用了这么久的MySQL了。</p>
<h3 id="复现"><a class="header-anchor" href="#复现">¶</a>复现</h3>
<p>遂走到3d童鞋的旁边，3d童鞋也非常熟练的explain plan了一下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">mysql test@****:**&gt; explain SELECT</span><br><span class="line">                 -&gt;   c.c_code as cCode,</span><br><span class="line">                 -&gt;   u.u_code as uCode,</span><br><span class="line">                 -&gt;   h.h_code as hCode</span><br><span class="line">                 -&gt; FROM c</span><br><span class="line">                 -&gt;   join u on c.u_code = u.u_code</span><br><span class="line">                 -&gt;   join h on h.h_code = u.h_code</span><br><span class="line">                 -&gt; WHERE c.c_code = 'xxxxxxxxxxxxx'\G;</span><br><span class="line">***************************[ 1. row ]***************************</span><br><span class="line">id            | 1</span><br><span class="line">select_type   | SIMPLE</span><br><span class="line">table         | c</span><br><span class="line">type          | const</span><br><span class="line">possible_keys | uniq_c,idx_u_code</span><br><span class="line">key           | uniq_c</span><br><span class="line">key_len       | 82</span><br><span class="line">ref           | const</span><br><span class="line">rows          | 1</span><br><span class="line">Extra         | &lt;null&gt;</span><br><span class="line">***************************[ 2. row ]***************************</span><br><span class="line">id            | 1</span><br><span class="line">select_type   | SIMPLE</span><br><span class="line">table         | h</span><br><span class="line">type          | ALL</span><br><span class="line">possible_keys | uniq_h_code</span><br><span class="line">key           | &lt;null&gt;</span><br><span class="line">key_len       | &lt;null&gt;</span><br><span class="line">ref           | &lt;null&gt;</span><br><span class="line">rows          | 3110</span><br><span class="line">Extra         | &lt;null&gt;</span><br><span class="line">***************************[ 3. row ]***************************</span><br><span class="line">id            | 1</span><br><span class="line">select_type   | SIMPLE</span><br><span class="line">table         | u</span><br><span class="line">type          | ref</span><br><span class="line">possible_keys | idx_h_code</span><br><span class="line">key           | idx_h_code</span><br><span class="line">key_len       | 62</span><br><span class="line">ref           | **.h.h_code</span><br><span class="line">rows          | 5</span><br><span class="line">Extra         | Using where</span><br><span class="line">3 rows in set</span><br></pre></td></tr></table></figure>
<p>我去，妥妥的慢查询啊，这不科学。 仔细分析下这个查询，c和u表都按照我们的设计，走了索引，那问题的关键就是在h表上了：明明找到了uniq_h_code，为啥最终没有走这个唯一索引呢？</p>
<h3 id="分析"><a class="header-anchor" href="#分析">¶</a>分析</h3>
<p>为了缩小问题的范围，我们决定拆分这个SQL：先试试c与u的join，再试试u与h的join。</p>
<p>首先explain c与u：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">mysql test@****:**&gt; explain SELECT</span><br><span class="line">                 -&gt;   c.c_code as cCode,</span><br><span class="line">                 -&gt;   u.u_code as uCode</span><br><span class="line">                 -&gt; FROM c</span><br><span class="line">                 -&gt;   join u on c.u_code = u.u_code</span><br><span class="line">                 -&gt; WHERE c.c_code = 'xxxxxxxxxxxxx'\G;</span><br><span class="line">***************************[ 1. row ]***************************</span><br><span class="line">id            | 1</span><br><span class="line">select_type   | SIMPLE</span><br><span class="line">table         | c</span><br><span class="line">type          | const</span><br><span class="line">possible_keys | uniq_c,idx_u_code</span><br><span class="line">key           | uniq_c</span><br><span class="line">key_len       | 82</span><br><span class="line">ref           | const</span><br><span class="line">rows          | 1</span><br><span class="line">Extra         | &lt;null&gt;</span><br><span class="line">***************************[ 2. row ]***************************</span><br><span class="line">id            | 1</span><br><span class="line">select_type   | SIMPLE</span><br><span class="line">table         | u</span><br><span class="line">type          | index</span><br><span class="line">possible_keys | &lt;null&gt;</span><br><span class="line">key           | uniq_u_code</span><br><span class="line">key_len       | 62</span><br><span class="line">ref           | &lt;null&gt;</span><br><span class="line">rows          | 20434</span><br><span class="line">Extra         | Using where; Using index</span><br><span class="line">2 rows in set</span><br></pre></td></tr></table></figure>
<p>然后是explain u与h：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">mysql test@****:**&gt; explain SELECT</span><br><span class="line">                 -&gt;   u.u_code as uCode,</span><br><span class="line">                 -&gt;   h.h_code as hCode</span><br><span class="line">                 -&gt; FROM u</span><br><span class="line">                 -&gt;   join h on h.h_code = u.h_code</span><br><span class="line">                 -&gt; WHERE c.u_code = 'xxxxxxxxxxxxx'\G;</span><br><span class="line">***************************[ 1. row ]***************************</span><br><span class="line">id            | 1</span><br><span class="line">select_type   | SIMPLE</span><br><span class="line">table         | h</span><br><span class="line">type          | const</span><br><span class="line">possible_keys | uniq_h_code</span><br><span class="line">key           | uniq_h_code</span><br><span class="line">key_len       | 62</span><br><span class="line">ref           | const</span><br><span class="line">rows          | 1</span><br><span class="line">Extra         | Using index</span><br><span class="line">***************************[ 2. row ]***************************</span><br><span class="line">id            | 1</span><br><span class="line">select_type   | SIMPLE</span><br><span class="line">table         | u</span><br><span class="line">type          | ref</span><br><span class="line">possible_keys | idx_h_code</span><br><span class="line">key           | idx_h_code</span><br><span class="line">key_len       | 62</span><br><span class="line">ref           | const</span><br><span class="line">rows          | 1</span><br><span class="line">Extra         | Using index condition</span><br><span class="line">2 rows in set</span><br></pre></td></tr></table></figure>
<p>答案很明显，u和h的join没任何问题，按照我们的期望走了索引。而c和u的join出现了问题，虽然type是index，但是仍然属于全表扫描的范畴，最为诡异的是，possible_keys里没找到对应的索引……</p>
<p>为了继续找原因，决定试一试用<code>FORCE INDEX</code>的方式去限制下MySQL的索引使用，仅局限到我们指定的索引上：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">mysql test@****:**&gt; explain SELECT</span><br><span class="line">                 -&gt;   c.c_code as cCode,</span><br><span class="line">                 -&gt;   u.u_code as uCode</span><br><span class="line">                 -&gt; FROM c</span><br><span class="line">                 -&gt;   join u on c.u_code = u.u_code</span><br><span class="line">                 -&gt; WHERE c.c_code = 'xxxxxxxxxxxxx'\G;</span><br><span class="line">***************************[ 1. row ]***************************</span><br><span class="line">id            | 1</span><br><span class="line">select_type   | SIMPLE</span><br><span class="line">table         | c</span><br><span class="line">type          | const</span><br><span class="line">possible_keys | uniq_c,idx_u_code</span><br><span class="line">key           | uniq_c</span><br><span class="line">key_len       | 82</span><br><span class="line">ref           | const</span><br><span class="line">rows          | 1</span><br><span class="line">Extra         | &lt;null&gt;</span><br><span class="line">***************************[ 2. row ]***************************</span><br><span class="line">id            | 1</span><br><span class="line">select_type   | SIMPLE</span><br><span class="line">table         | u</span><br><span class="line">type          | index</span><br><span class="line">possible_keys | &lt;null&gt;</span><br><span class="line">key           | uniq_u_code</span><br><span class="line">key_len       | 62</span><br><span class="line">ref           | &lt;null&gt;</span><br><span class="line">rows          | 20434</span><br><span class="line">Extra         | Using where; Using index</span><br><span class="line">2 rows in set</span><br></pre></td></tr></table></figure>
<p>然而，MySQL继续打我的脸，仍然没有按照预期去走索引，仅仅走了index。</p>
<p>分析到此暂时就没有了近一步的突破，毕竟explain plan的结果已经颠覆了我对MySQL的认知：明显u表上有u_code唯一索引uniq_u_code，为什么还是不能走索引呢？为此，带着这个问题去请教了我们可爱的DBA童鞋……</p>
<p>嗯，3个小时后，可爱的DBA童鞋回复了我们：因为c表的charsets是utf8mb4，而u和h表的charsets是utf8，所以join的时候只能走index了……</p>
<p>果然……事情的真相只有一个啊……</p>
<p>至于不知道utf8和utf8mb4区别的可以看<a href="http://seanlook.com/2016/10/23/mysql-utf8mb4/" target="_blank" rel="noopener">这里</a></p>
<h3 id="总结"><a class="header-anchor" href="#总结">¶</a>总结</h3>
<p>在写这篇blog的时候，顺便在Google上检索了一下，发现，有人也踩过<a href="https://mp.weixin.qq.com/s/ns9eRxjXZfUPNSpfgGA7UA" target="_blank" rel="noopener">同样的坑</a>，charsets果真就是个神坑……生产环境的charsets问题在半个月前被我注意到了，当时认为，没用到emoji不会有啥问题，只是没想到在这种情况下依然被坑，图样图森破啊……</p>
<p>至于解决方案，自然就是转换生产环境表的charsets了，权当涨姿势吧。</p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://purplest.github.io/blog/blog/2017/04/01/深入理解Zookeeper/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="purplest">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一些微小的记录">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/blog/blog/2017/04/01/深入理解Zookeeper/" class="post-title-link" itemprop="http://purplest.github.io/blog/index.html">深入理解Zookeeper</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2017-04-01 00:00:00" itemprop="dateCreated datePublished" datetime="2017-04-01T00:00:00+08:00">2017-04-01</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2017-04-07 15:15:24" itemprop="dateModified" datetime="2017-04-07T15:15:24+08:00">2017-04-07</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/blog/categories/Zookeeper/" itemprop="url" rel="index"><span itemprop="name">Zookeeper</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近阅读了大部分Zookeeper的源码，并对分布式的相关机制有了一定的了解，故写了篇gitbook，也当做是一个记录吧。<br>
地址：<a href="https://purplest.gitbooks.io/zookeeper-source-code/content/" target="_blank" rel="noopener">Zookeeper Source Code</a></p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://purplest.github.io/blog/blog/2016/09/20/Contravariance & Covariance In Java Generics/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="purplest">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一些微小的记录">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/blog/blog/2016/09/20/Contravariance & Covariance In Java Generics/" class="post-title-link" itemprop="http://purplest.github.io/blog/index.html">Contravariance & Covariance in Java Generics</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2016-09-20 00:00:00" itemprop="dateCreated datePublished" datetime="2016-09-20T00:00:00+08:00">2016-09-20</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2017-03-30 18:32:32" itemprop="dateModified" datetime="2017-03-30T18:32:32+08:00">2017-03-30</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/blog/categories/architecture/" itemprop="url" rel="index"><span itemprop="name">architecture</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1>Java Generics</h1>
<p>Java 泛型相较于C++的实现，有联系，也有区别。下面通过一个栗子来了解。</p>
<h3 id="一个arrays引发的exception"><a class="header-anchor" href="#一个arrays引发的exception">¶</a>一个Arrays引发的Exception</h3>
<p>首先，我们定义以下两个array。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Integer[] arrInt = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;;</span><br><span class="line">Number[] arrNum = arrInt;</span><br></pre></td></tr></table></figure>
<p>很显然，把arrNum指向arrInt是没有任何问题的。但是如果像下面这样改变其中的某个值呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arrNum[<span class="number">1</span>]=<span class="number">1.1</span>;</span><br></pre></td></tr></table></figure>
<p>对于编译器来说，这样是完全没有问题的，因为Double是Number的子类。但是如果运行的话，会抛出<code>java.lang.ArrayStoreException</code>，因为arrNum本质还是一个Integer array，把一个Double放进一个Integer里显然是不可能的。</p>
<p>回到问题的本质，这样相当于绕过了编译器，但是对runtime环境来说，arrNum指向的对象在JVM中其实还是个Integer[]的实例。</p>
<p>因此，我们也把arrays称作<code>reifiable type</code>。</p>
<h3 id="java-generics"><a class="header-anchor" href="#java-generics">¶</a>Java Generics</h3>
<p>在JVM中，并没有泛型这个东西，而JDK 1.5之后其实也是通过type erasure，利用 compiler添加的bridge方法来实现泛型的。</p>
<p>因为在JVM里并不存在泛型，所以没办法拿到type infomation，所以也没办法避免可能的heap pollution。比如下面的栗子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt; integerList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">integerList.add(<span class="number">2</span>);</span><br><span class="line">integerList.add(<span class="number">3</span>);</span><br><span class="line">integerList.add(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">List&lt;Number&gt; numberList = integerList;<span class="comment">//compiler error</span></span><br></pre></td></tr></table></figure>
<p>很显然，把List<number>指向List<integer>，会导致compile error，如果编译器不阻止这种转换，就会导致下面的heap pollution。</integer></number></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">numberList.add(<span class="number">3.14</span>);<span class="comment">//heap pollution</span></span><br></pre></td></tr></table></figure>
<p>因此，我们也把泛型的这种情况称作<code>non-reifiable type</code>。</p>
<h3 id="in-polymorphism"><a class="header-anchor" href="#in-polymorphism">¶</a>In polymorphism</h3>
<p>下面再看个多态的栗子，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">sum</span><span class="params">(Number[] numbers)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">long</span> sum = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span> (Number number : numbers) &#123;</span><br><span class="line">		sum += number.longValue();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以这样使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Integer[] integers = &#123;<span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">11</span>&#125;;</span><br><span class="line">Long[] longs = &#123;<span class="number">2l</span>, <span class="number">3l</span>, <span class="number">5l</span>, <span class="number">7l</span>, <span class="number">11l</span>&#125;;</span><br><span class="line">Double[] doubles = &#123;<span class="number">2.0</span>, <span class="number">3.0</span>, <span class="number">5.0</span>, <span class="number">7.0</span>, <span class="number">11.0</span>&#125;;</span><br><span class="line"></span><br><span class="line">System.out.println(sum(integers));</span><br><span class="line">System.out.println(sum(longs));</span><br><span class="line">System.out.println(sum(doubles));</span><br></pre></td></tr></table></figure>
<p>显然，这样调用是没问题的，但是直接传一个arrays并不符合封装性，可能导致其他的问题。那我们换做泛型来看看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">sum</span><span class="params">(List&lt;Number&gt; numbers)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">long</span> sum = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span> (Number number : numbers) &#123;</span><br><span class="line">		sum += number.longValue();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有了上面的经验，想当然的试着这么调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt; integers = Lists.newArrayList(<span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">11</span>);</span><br><span class="line">List&lt;Long&gt; longs = Lists.newArrayList(<span class="number">2l</span>, <span class="number">3l</span>, <span class="number">5l</span>, <span class="number">7l</span>, <span class="number">11l</span>);</span><br><span class="line">List&lt;Double&gt; doubles = Lists.newArrayList(<span class="number">2.0</span>, <span class="number">3.0</span>, <span class="number">5.0</span>, <span class="number">7.0</span>, <span class="number">11.0</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(sum(integers));</span><br><span class="line">System.out.println(sum(longs));</span><br><span class="line">System.out.println(sum(doubles));</span><br></pre></td></tr></table></figure>
<p>然而事实是残酷的，编译器拒绝了我并抛了一个Error。为了一探究竟，我们需要了解Java Generics中两个非常有用的特性：covariance和contravariance。</p>
<h3 id="covariance"><a class="header-anchor" href="#covariance">¶</a>Covariance</h3>
<p>在covariance中，我们可以read泛型中的某个item，但是禁止write。比如有以下的声明：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">List&lt;? extends Number&gt; integers = <span class="keyword">new</span> ArrayList&lt;Integer&gt;();</span><br><span class="line">List&lt;? extends Number&gt; longs = <span class="keyword">new</span> ArrayList&lt;Long&gt;();</span><br><span class="line">List&lt;? extends Number&gt; doubles = <span class="keyword">new</span> ArrayList&lt;Double&gt;();</span><br></pre></td></tr></table></figure>
<p>那么我们可以随意的read某个item：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Number numberI = integers.get(<span class="number">1</span>)</span><br><span class="line">Number numberL = longs.get(<span class="number">1</span>)</span><br><span class="line">Number numberD = doubles.get(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>因为在这个泛型中，限制了所有的元素一定为Number的子类，所以我们肯定可以upcaset to Number。</p>
<p>但是，在covariance中却无法write：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">numberI.add(<span class="number">7</span>); <span class="comment">//compiler error</span></span><br></pre></td></tr></table></figure>
<p>因为numberI限定了所有元素是Number的子类，但却不知道到底是哪个子类（也许是个List<double>呢？），因为编译器无法保证它的真正的类型是什么。所以，可以达到只读的特性。</double></p>
<h3 id="contravariance"><a class="header-anchor" href="#contravariance">¶</a>Contravariance</h3>
<p>同样的，covariance反过来就是contravariance。我们可以在泛型中write，但是禁止write。栗子如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Object&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">list.add(<span class="keyword">new</span> BigInteger(<span class="string">"1024"</span>));</span><br><span class="line">list.add(<span class="string">"65535"</span>);</span><br><span class="line"></span><br><span class="line">List&lt;? <span class="keyword">super</span> Number&gt; numbers = list;</span><br><span class="line">numbers.add(<span class="number">64</span>);</span><br></pre></td></tr></table></figure>
<p>因为Object一定是Number的父类，而Number是Interger的父类，所以这个add是合法的。</p>
<p>但是，在contravariance中却无法read：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Number number = numbers.get(<span class="number">0</span>); <span class="comment">//compiler error</span></span><br></pre></td></tr></table></figure>
<p>因为编译器只知道下限，却无法知道具体是哪个父类。如果编译器允许这种add，则可能导致运行时抛出<code>java.lang.ClassCastException</code>。</p>
<h3 id="best-practice"><a class="header-anchor" href="#best-practice">¶</a>Best practice</h3>
<p>在弄清楚covariance和contravariance之后，我们就有办法用好这两个特性了，有个总结是：PECS，即：“Producer extends, Comsumer super”。</p>
<p>对于需要read的泛型，可以这么实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getAll</span><span class="params">(List&lt;? extends Number&gt; items)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (Number item : items) &#123;</span><br><span class="line">		<span class="keyword">do</span> (item);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于需要write的泛型，可以这么实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putAll</span><span class="params">(List&lt;? <span class="keyword">super</span> Number&gt; items)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (Number obj : list) &#123;</span><br><span class="line">		items.add(obj);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上所有内容可以参考<a href="http://stackoverflow.com/questions/1368166/what-is-a-difference-between-super-e-and-extends-e" target="_blank" rel="noopener">stackoverflow</a>。</p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://purplest.github.io/blog/blog/2016/08/15/Reference type of volatile/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="purplest">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一些微小的记录">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/blog/blog/2016/08/15/Reference type of volatile/" class="post-title-link" itemprop="http://purplest.github.io/blog/index.html">Reference type of volatile</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2016-08-15 00:00:00" itemprop="dateCreated datePublished" datetime="2016-08-15T00:00:00+08:00">2016-08-15</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2017-03-30 19:56:06" itemprop="dateModified" datetime="2017-03-30T19:56:06+08:00">2017-03-30</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/blog/categories/architecture/" itemprop="url" rel="index"><span itemprop="name">architecture</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>众所周知，在Java中，由JMM保证了volatile的顺序性以及可见性，并且能看到很多介绍volatile的文章，但是大家在介绍volatile的时候，似乎都在着重说明volatile的语义，以及JVM如何在跨平台的时候插入内存屏障来保证volatile的特性的，而在举例子的时候，似乎都是用primitive type作为例子的，比如，boolean作为开关，int作为计数器 or version ID。</p>
<p>但是一直有个疑问，对于reference type，JVM到底是如何保证volatile的语义的呢？会不会像final一样，仅仅只是修饰这个reference呢？带着这个疑问，咱们尝试通过汇编代码来一探究竟。</p>
<h3 id="0-准备工具"><a class="header-anchor" href="#0-准备工具">¶</a>0.准备工具</h3>
<p>显然，普通方法是没办法查看到对应的汇编代码的。通过javac xxx只能看到对应的bytecode，对底层的内存屏障之类的东西，其实还是透明的。so，咱们需要引入一个小工具，它叫hsdis。</p>
<p>关于这个小工具，有很多办法可以获取，<a href="https://kenai.com/projects/base-hsdis/downloads" target="_blank" rel="noopener">Kenai官方</a>提供了bsd、<a href="http://xn--linuxsolaris-m86sg26cc42a6yisvpg79f.so" target="_blank" rel="noopener">linux以及solaris所对应的.so</a>，选择对应的CPU架构即可（i386 or amd64）。</p>
<p>当然，这个时候肯定有人跳出来说，“喂，就这么无视我们windows么？”nonono，我才不会说我也用的是windows呢~对应的方法，无非也就是：</p>
<ul>
<li>[ ] <a href="http://dropzone.nfshost.com/hsdis.htm" target="_blank" rel="noopener">自己编译，丰衣足食</a>。</li>
<li>[x] <a href="http://vorboss.dl.sourceforge.net/project/fcml/fcml-1.1.1/hsdis-1.1.1-win32-amd64.zip" target="_blank" rel="noopener">为啥不用编译好的呢~</a></li>
</ul>
<p>作为一个懒到了无药可救的人来说，肯定是选择第二个啦~</p>
<p>偷偷的说一句，其实只是参考了<a href="http://stackoverflow.com/questions/1503479/how-to-see-jit-compiled-code-in-jvm" target="_blank" rel="noopener">这个答案</a>的啦~</p>
<p>当然，废话一句，下载后讲dll放进<code>%JAVA_HOME%\jre\bin\server</code>就OK了</p>
<h3 id="1-热身"><a class="header-anchor" href="#1-热身">¶</a>1.热身</h3>
<p>下面是见证奇迹的时刻。</p>
<p>首先，我们先来一段简单的代码热热身，先看看primitive type生成的汇编指令是啥样。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        i = <span class="number">5</span>;</span><br><span class="line">        <span class="keyword">return</span> i;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Main main = <span class="keyword">new</span> Main();</span><br><span class="line">        System.out.println(main.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为生成的汇编代码实在太多了，因此我们需要限制某个点，就取get方法，并且重定向一下。</p>
<p><code>java -XX:+UnlockDiagnosticVMOptions -XX:+PrintAssembly -Xcomp -XX:CompileCommand=dontinline,*Main.get -XX:CompileCommand=compileonly,*Main.get Main &gt; main</code></p>
<p>因为汇编代码实在太多，因此只取部分来说</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">0x0000000002a5fc5f: mov     rax,170802d0h     ;   &#123;metadata(&#123;method&#125; &#123;0x00000000170802d8&#125; &apos;get&apos; &apos;()I&apos; in &apos;Main&apos;)&#125;</span><br><span class="line">0x0000000002a5fc69: and     esi,0h</span><br><span class="line">0x0000000002a5fc6c: cmp     esi,0h</span><br><span class="line">0x0000000002a5fc6f: je      2a5fc91h          ;*aload_0</span><br><span class="line">                                              ; - Main::get@0 (line 6)</span><br><span class="line"></span><br><span class="line">0x0000000002a5fc75: mov     eax,5h</span><br><span class="line">0x0000000002a5fc7a: mov     dword ptr [rdx+0ch],eax</span><br><span class="line">0x0000000002a5fc7d: lock add dword ptr [rsp],0h  ;*putfield i</span><br><span class="line">                                              ; - Main::get@2 (line 6)</span><br><span class="line"></span><br><span class="line">0x0000000002a5fc82: mov     eax,dword ptr [rdx+0ch]  ;*getfield i</span><br><span class="line">                                              ; - Main::get@6 (line 7)</span><br><span class="line"></span><br><span class="line">0x0000000002a5fc85: add     rsp,30h</span><br><span class="line">0x0000000002a5fc89: pop     rbp</span><br><span class="line">0x0000000002a5fc8a: test    dword ptr [1e0100h],eax  ;   &#123;poll_return&#125;</span><br><span class="line">0x0000000002a5fc90: ret</span><br></pre></td></tr></table></figure>
<p>恩，非常棒的是，列出了调用的方法名，返回值，以及第几行。</p>
<p>我们可以看到，因为在intel的X86架构下，只对<code>StoreLoad</code>操作需要添加内存屏障（具体细节请参考<a href="http://g.oswego.edu/dl/jmm/cookbook.html" target="_blank" rel="noopener">JSR-133</a>），而从生成的汇编指令中也可以看出，是通过<code>lock add xxx</code>操作来达到目的。</p>
<h3 id="2-正餐"><a class="header-anchor" href="#2-正餐">¶</a>2.正餐</h3>
<p>那试完了primitive type，就该来看看reference type了。</p>
<p>首先先看java源码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Inner</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> num;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">volatile</span> Inner inner;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.inner = <span class="keyword">new</span> Inner();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Inner <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        inner = <span class="keyword">new</span> Inner();</span><br><span class="line">        inner.num = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> inner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Main main = <span class="keyword">new</span> Main();</span><br><span class="line">        System.out.println(main.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于inner的new和inner.num的复制操作，会是哪个需要加入内存屏障呢？根据我们的经验，这个volatile应该是用来修饰inner的，那么我们生成汇编指令来看看呗。</p>
<p>还是熟悉的味道，还是原来的代码来生成汇编指令。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">0x0000000002a40a87: call    2985ee0h          ; OopMap&#123;[56]=Oop [48]=Oop off=204&#125;</span><br><span class="line">                                              ;*invokespecial &lt;init&gt;</span><br><span class="line">                                              ; - Main::get@7 (line 14)</span><br><span class="line">                                              ;   &#123;optimized virtual_call&#125;</span><br><span class="line">0x0000000002a40a8c: mov     rax,qword ptr [rsp+30h]</span><br><span class="line">0x0000000002a40a91: mov     rdx,qword ptr [rsp+38h]</span><br><span class="line">0x0000000002a40a96: mov     r10,rax</span><br><span class="line">0x0000000002a40a99: mov     dword ptr [rdx+0ch],r10d</span><br><span class="line">0x0000000002a40a9d: mov     rax,rdx</span><br><span class="line">0x0000000002a40aa0: shr     rax,9h</span><br><span class="line">0x0000000002a40aa4: mov     rsi,118f5000h</span><br><span class="line">0x0000000002a40aae: mov     byte ptr [rax+rsi],0h</span><br><span class="line">0x0000000002a40ab2: lock add dword ptr [rsp],0h  ;*putfield inner</span><br><span class="line">                                              ; - Main::get@10 (line 14)</span><br><span class="line"></span><br><span class="line">0x0000000002a40ab7: mov     eax,dword ptr [rdx+0ch]  ;*getfield inner</span><br><span class="line">                                              ; - Main::get@14 (line 15)</span><br><span class="line"></span><br><span class="line">0x0000000002a40aba: mov     dword ptr [rax+0ch],0h  ;*putfield num</span><br><span class="line">                                              ; - Main::get@18 (line 15)</span><br><span class="line">                                              ; implicit exception: dispatches to 0x0000000002a40af4</span><br><span class="line">0x0000000002a40ac1: mov     eax,dword ptr [rdx+0ch]  ;*getfield inner</span><br><span class="line">                                              ; - Main::get@22 (line 16)</span><br><span class="line"></span><br><span class="line">0x0000000002a40ac4: add     rsp,50h</span><br><span class="line">0x0000000002a40ac8: pop     rbp</span><br><span class="line">0x0000000002a40ac9: test    dword ptr [260100h],eax  ;   &#123;poll_return&#125;</span><br><span class="line">0x0000000002a40acf: ret</span><br></pre></td></tr></table></figure>
<p>汇编很长，照理只截取重点。</p>
<p>可以从汇编指令中看到，首先有个call，这个call的作用是调用<code>*invokespecial &lt;init&gt;</code>来初始化inner的（1.7新加入的指令），初始化完后JVM直接在第14行后用<code>lock add xxx</code>来做了同步，而下面的第15行对inner.num的写入操作被JVM红果果的忽视了。</p>
<p>看来已经通过汇编源码验证了咱们的猜想，已经是时候下结论了，即volatile只是保证它修饰的那个参数的正确同步，对于reference type来说，只能保证对引用的正确同步。</p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://purplest.github.io/blog/blog/2016/03/22/Striped64/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="purplest">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一些微小的记录">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/blog/blog/2016/03/22/Striped64/" class="post-title-link" itemprop="http://purplest.github.io/blog/index.html">Striped64</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2016-03-22 00:00:00" itemprop="dateCreated datePublished" datetime="2016-03-22T00:00:00+08:00">2016-03-22</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2017-03-30 18:34:14" itemprop="dateModified" datetime="2017-03-30T18:34:14+08:00">2017-03-30</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/blog/categories/jdk-8/" itemprop="url" rel="index"><span itemprop="name">jdk 8</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在上上篇blog中，介绍了LongAdder、LongAccumulator这两个类，但是还没说实现longAccumulate的Striped64类，这篇单独说之。</p>
<p>在LongAdder里边提到了Cell[]，其实关键在于维护这一系列并发的状态，而longAccumulate维护了这些状态。</p>
<p>简单来说，Cell[]一共有三种状态：</p>
<p>①Cell[]已经初始化；</p>
<p>②Cell[]未被初始化并且拿到了操作Cell[]的锁cellsBusy；</p>
<p>③Cell[]未被初始化并且没拿到cellsBusy锁；</p>
<ul>
<li>对于状态①，则在初始化的Cell[]里边进行操作即可；</li>
<li>对于状态②，既然拿到了锁cellsBusy，则初始化Cell[]并在初始化完后释放cellsBusy锁即可。</li>
<li>对于状态③，Cell[]未被初始化并且没拿到锁，说明Cell[]正在被初始化，也从侧面说明现在对base的竞争并不激烈，所以回退去使用base即可。</li>
</ul>
<p>下面详细对源码进行解析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">longAccumulate</span><span class="params">(<span class="keyword">long</span> x, LongBinaryOperator fn,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    <span class="keyword">boolean</span> wasUncontended)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">int</span> h;</span><br><span class="line">   <span class="comment">//当前进程未被初始化（从1开始计数）</span></span><br><span class="line">   <span class="keyword">if</span> ((h = getProbe()) == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">//强制初始化</span></span><br><span class="line">      ThreadLocalRandom.current();</span><br><span class="line">      h = getProbe();</span><br><span class="line">      wasUncontended = <span class="keyword">true</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">boolean</span> collide = <span class="keyword">false</span>;    <span class="comment">// True if last slot nonempty</span></span><br><span class="line">   <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">      Cell[] as; Cell a; <span class="keyword">int</span> n; <span class="keyword">long</span> v;</span><br><span class="line">      <span class="comment">//状态①：Cell[]已初始化</span></span><br><span class="line">      <span class="keyword">if</span> ((as = cells) != <span class="keyword">null</span> &amp;&amp; (n = as.length) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="comment">//当前选择的slot是null的，则需要去初始化当前slot</span></span><br><span class="line">         <span class="keyword">if</span> ((a = as[(n - <span class="number">1</span>) &amp; h]) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//先去看能否拿到cellsBusy</span></span><br><span class="line">            <span class="keyword">if</span> (cellsBusy == <span class="number">0</span>) &#123;</span><br><span class="line">               <span class="comment">//认为没有人去拿锁，先初始化Cell（即乐观锁）</span></span><br><span class="line">               Cell r = <span class="keyword">new</span> Cell(x);</span><br><span class="line">               <span class="comment">//初始化完后再去拿锁</span></span><br><span class="line">               <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; casCellsBusy()) &#123;</span><br><span class="line">                  <span class="keyword">boolean</span> created = <span class="keyword">false</span>;</span><br><span class="line">                  <span class="keyword">try</span> &#123;               <span class="comment">// Recheck under lock</span></span><br><span class="line">                     Cell[] rs; <span class="keyword">int</span> m, j;</span><br><span class="line">                     <span class="comment">//拿到锁的情况下再确认当前slot是否为null</span></span><br><span class="line">                     <span class="keyword">if</span> ((rs = cells) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                        (m = rs.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                        rs[j = (m - <span class="number">1</span>) &amp; h] == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">//关联到当前位置的Cell</span></span><br><span class="line">                        rs[j] = r;</span><br><span class="line">                        created = <span class="keyword">true</span>;</span><br><span class="line">                     &#125;</span><br><span class="line">                  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                     <span class="comment">//释放锁</span></span><br><span class="line">                     cellsBusy = <span class="number">0</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="keyword">if</span> (created)</span><br><span class="line">                     <span class="comment">//成功创建并关联到当前位置的Cell</span></span><br><span class="line">                     <span class="keyword">break</span>;</span><br><span class="line">                  <span class="comment">//否则slot不为null</span></span><br><span class="line">                  <span class="keyword">continue</span>;</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//没能拿到cellsBusy锁，重新选择slot</span></span><br><span class="line">            collide = <span class="keyword">false</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">//已经知道CAS会失败了，则重新选择slot后再继续</span></span><br><span class="line">         <span class="keyword">else</span> <span class="keyword">if</span> (!wasUncontended)</span><br><span class="line">            wasUncontended = <span class="keyword">true</span>;</span><br><span class="line">          <span class="comment">//当前slot非null，则去试着CAS更新</span></span><br><span class="line">         <span class="keyword">else</span> <span class="keyword">if</span> (a.cas(v = a.value, ((fn == <span class="keyword">null</span>) ? v + x :</span><br><span class="line">                                    fn.applyAsLong(v, x))))</span><br><span class="line">            <span class="comment">//更新成功</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">         <span class="comment">//超过CPU数限制or当前Cell[]已经扩容了</span></span><br><span class="line">         <span class="keyword">else</span> <span class="keyword">if</span> (n &gt;= NCPU || cells != as)</span><br><span class="line">            collide = <span class="keyword">false</span>;</span><br><span class="line">         <span class="comment">//如果没有竞争，则标记为存在竞争，并重新选择slot重试</span></span><br><span class="line">         <span class="keyword">else</span> <span class="keyword">if</span> (!collide)</span><br><span class="line">            collide = <span class="keyword">true</span>;</span><br><span class="line">         <span class="comment">//有竞争，并且拿到了cellsBusy锁，则进行扩容</span></span><br><span class="line">         <span class="keyword">else</span> <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; casCellsBusy()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="comment">// 再check一下Cell[]是否有过扩容</span></span><br><span class="line">               <span class="keyword">if</span> (cells == as) &#123;</span><br><span class="line">                  <span class="comment">//容量翻倍</span></span><br><span class="line">                  Cell[] rs = <span class="keyword">new</span> Cell[n &lt;&lt; <span class="number">1</span>];</span><br><span class="line">                  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; ++i)</span><br><span class="line">                     rs[i] = as[i];</span><br><span class="line">                  cells = rs;</span><br><span class="line">               &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">               <span class="comment">//释放cellsBusy锁</span></span><br><span class="line">               cellsBusy = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            collide = <span class="keyword">false</span>;</span><br><span class="line">            <span class="comment">//在扩容后的Cell上重试</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">//rehash，选择其他slot</span></span><br><span class="line">         h = advanceProbe(h);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//状态②：Cell[]未被初始化，并且拿到了cellsBusy锁</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; cells == as &amp;&amp; casCellsBusy()) &#123;</span><br><span class="line">         <span class="keyword">boolean</span> init = <span class="keyword">false</span>;</span><br><span class="line">         <span class="comment">//初始化Cell[]</span></span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (cells == as) &#123;</span><br><span class="line">               Cell[] rs = <span class="keyword">new</span> Cell[<span class="number">2</span>];</span><br><span class="line">               rs[h &amp; <span class="number">1</span>] = <span class="keyword">new</span> Cell(x);</span><br><span class="line">               cells = rs;</span><br><span class="line">               init = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//释放cellsBusy锁</span></span><br><span class="line">            cellsBusy = <span class="number">0</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span> (init)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//状态③：Cell[]正在被初始化，回退到CAS base</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (casBase(v = base, ((fn == <span class="keyword">null</span>) ? v + x :</span><br><span class="line">                               fn.applyAsLong(v, x))))</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>总结:</p>
<p>Striped64实现了对Cell[]的维护以及选取slot更新，是LongAdder、LongAccumulator等类的基础。</p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://purplest.github.io/blog/blog/2016/03/21/False sharing/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="purplest">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一些微小的记录">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/blog/blog/2016/03/21/False sharing/" class="post-title-link" itemprop="http://purplest.github.io/blog/index.html">False sharing</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2016-03-21 00:00:00" itemprop="dateCreated datePublished" datetime="2016-03-21T00:00:00+08:00">2016-03-21</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2017-03-30 18:34:35" itemprop="dateModified" datetime="2017-03-30T18:34:35+08:00">2017-03-30</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/blog/categories/architecture/" itemprop="url" rel="index"><span itemprop="name">architecture</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在缓存系统（cache system）中，缓存行（cache lines）是最基本的存储单位，缓存行是2的整数次幂个连续的字节，一般是32-256个字节，最常见的一个缓存行是64个字节。CPU在读取数据的时候，是整个缓存行一起读取的，在多核处理器上，会发生竞争的问题，比如core A修改了变量X，core B修改了Y，而X，Y都在同一个缓存行上，因为数据一致性的问题，如果core A修改成功了，那么core B的缓存就失效了，数据必须从新去读取，反之亦然。如果发生的概率很高，必然会使cache失去了作用，导致效率降低。<br>
（详细解读:<a href="http://ifeve.com/false-sharing/" target="_blank" rel="noopener">False sharing</a>）</p>
<p>在&lt;JDK 8之前的版本中，在面对false sharing的问题，通常解决办法是做填充，比如在1.7的ThreadLocalRandom中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalRandom</span> <span class="keyword">extends</span> <span class="title">Random</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The random seed. We can't use super.seed.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> rnd;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Padding to help avoid memory contention among seed updates in</span></span><br><span class="line">    <span class="comment">// different TLRs in the common case that they are located near</span></span><br><span class="line">    <span class="comment">// each other.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> pad0, pad1, pad2, pad3, pad4, pad5, pad6, pad7;</span><br></pre></td></tr></table></figure>
<p>对于HotSpot JVM的内存布局，可以参考<a href="http://www.infoq.com/cn/articles/jvm-hotspot" target="_blank" rel="noopener">HotSpot虚拟机对象探秘</a>，并不需要深入的去看JVM，只需要知道在任意字段间用7个long做cache lines的填充行即可。</p>
<p>但带来的问题是，每个CPU对cache lines的定义是不同的，这种手动添加padding的方式不一定适合当前的CPU，而且属于不可移植的代码，违背了java编译一次，到处运行的法则。</p>
<p>还好，在JDK8中，带来了一个新的annotation：<code>sun.misc.Contended</code>，让JVM在分配内存的时候自动根据当前CPU的特性添加padding，改动之后被挪到了Thread里：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The following three initially uninitialized fields are exclusively</span></span><br><span class="line"><span class="comment">// managed by class java.util.concurrent.ThreadLocalRandom. These</span></span><br><span class="line"><span class="comment">// fields are used to build the high-performance PRNGs in the</span></span><br><span class="line"><span class="comment">// concurrent code, and we can not risk accidental false sharing.</span></span><br><span class="line"><span class="comment">// Hence, the fields are isolated with @Contended.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** The current seed for a ThreadLocalRandom */</span></span><br><span class="line"><span class="meta">@sun</span>.misc.Contended(<span class="string">"tlr"</span>)</span><br><span class="line"><span class="keyword">long</span> threadLocalRandomSeed;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Probe hash value; nonzero if threadLocalRandomSeed initialized */</span></span><br><span class="line"><span class="meta">@sun</span>.misc.Contended(<span class="string">"tlr"</span>)</span><br><span class="line"><span class="keyword">int</span> threadLocalRandomProbe;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Secondary seed isolated from public ThreadLocalRandom sequence */</span></span><br><span class="line"><span class="meta">@sun</span>.misc.Contended(<span class="string">"tlr"</span>)</span><br><span class="line"><span class="keyword">int</span> threadLocalRandomSecondarySeed;</span><br></pre></td></tr></table></figure>
<p><a href="http://mail.openjdk.java.net/pipermail/hotspot-dev/2012-November/007309.html" target="_blank" rel="noopener">JEP-142</a><br>
相对于其他版本的解决方式，是不是JDK8实现的更优雅了呢？ :)</p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://purplest.github.io/blog/blog/2016/03/18/LongAdder&LongAccumulator/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="purplest">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一些微小的记录">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/blog/blog/2016/03/18/LongAdder&LongAccumulator/" class="post-title-link" itemprop="http://purplest.github.io/blog/index.html">LongAdder & LongAccumulator</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2016-03-18 00:00:00" itemprop="dateCreated datePublished" datetime="2016-03-18T00:00:00+08:00">2016-03-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2017-03-30 18:34:58" itemprop="dateModified" datetime="2017-03-30T18:34:58+08:00">2017-03-30</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/blog/categories/jdk-8/" itemprop="url" rel="index"><span itemprop="name">jdk 8</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在JDK1.8中，java.util.concurrent.atomic包下增加了几个类:LongAdder、LongAccumulator、DoubleAdder、DoubleAccumulator，都是原Atomic的改进版。</p>
<p>在原Atomic系列类中，通过CAS的方式来保证在并发环境下的原子性，相对于synchronized和lock的方式来说，在并发环境下已经高效了很多了。但是在高并发下，CAS造作的失败率也会增加很多，失败率的增加导致了更多线程的重试，不仅浪费资源，也导致Atomic的效率降低。</p>
<p>通过对Atomic在高并发下的分析可以发现，瓶颈在于对单一value进行CAS操作失败率的增高，那有没有办法降低对单一value的CAS操作呢？在新的LongAdder中（以LongAdder举例），在高并发环境下，将单一value的CAS压力分担到多个的value上去，从而降低了失败率，提高了性能。</p>
<h3 id="1-longadder"><a class="header-anchor" href="#1-longadder">¶</a>1.LongAdder</h3>
<p>LongAdder继承自Striped64，而Striped64是实现在高并发下将压力分摊到不同value下的关键，并维护这些value。</p>
<p>LongAdder里的方法和Atomic里提供的方法很相似。</p>
<p>首先看add方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">long</span> x)</span> </span>&#123;</span><br><span class="line">	Cell[] as; <span class="keyword">long</span> b, v; <span class="keyword">int</span> m; Cell a;</span><br><span class="line">	<span class="keyword">if</span> ((as = cells) != <span class="keyword">null</span> || !casBase(b = base, b + x)) &#123;</span><br><span class="line">	    <span class="comment">//当对base的CAS操作失败后会进入</span></span><br><span class="line">		<span class="keyword">boolean</span> uncontended = </span><br><span class="line">		<span class="keyword">if</span> (as == <span class="keyword">null</span> || (m = as.length - <span class="number">1</span>) &lt; <span class="number">0</span> ||</span><br><span class="line">			(a = as[getProbe() &amp; m]) == <span class="keyword">null</span> ||</span><br><span class="line">			!(uncontended = a.cas(v = a.value, v + x)))</span><br><span class="line">			<span class="comment">//拿不到当前线程对应的cell或者对其CAS失败</span></span><br><span class="line">			longAccumulate(x, <span class="keyword">null</span>, uncontended);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在最开始，拿到了一个Cell的数组，这个Cell是Striped64的一个内部类，顾名思义，是Striped64用来分摊CAS压力的一个最小单元：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@sun</span>.misc.Contended <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Cell</span> </span>&#123;</span><br><span class="line">	<span class="keyword">volatile</span> <span class="keyword">long</span> value;</span><br><span class="line">	Cell(<span class="keyword">long</span> x) &#123; value = x; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">cas</span><span class="params">(<span class="keyword">long</span> cmp, <span class="keyword">long</span> val)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> UNSAFE.compareAndSwapLong(<span class="keyword">this</span>, valueOffset, cmp, val);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Unsafe mechanics</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> sun.misc.Unsafe UNSAFE;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> valueOffset;</span><br><span class="line">	<span class="keyword">static</span> &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			UNSAFE = sun.misc.Unsafe.getUnsafe();</span><br><span class="line">			Class&lt;?&gt; ak = Cell.class;</span><br><span class="line">			valueOffset = UNSAFE.objectFieldOffset</span><br><span class="line">				(ak.getDeclaredField(<span class="string">"value"</span>));</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> Error(e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>sun.misc.Contended是对cache line进行填充，避免<code>false sharing</code>，JDK1.8中可以用该annotation而不是前后各加7个long，在这里不过多解释。<br>
而Cell里的value，就是用来分担CAS更新的其中一个value，Cell里提供了对应的CAS操作。</p>
<p>我们回到add方法里。当并发很低的时候，基本没有CAS失败，所以通常情况下到第三行<code>!casBase(b = base, b + x)</code>中就进行了CAS操作；但是在并发量升高后，就会进入后续的判断,首先去拿Cell数组，并验证，根据当前线程的hash值，去拿Cell[]里的对应Cell，并对其的value进行CAS操作，如果Cell为null或者更新失败，就会进入Striped64的longAccumulate里进行操作。</p>
<p>longAccumulate过于复杂，暂时留在这里。</p>
<p>LongAdder还支持自增，自减操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">increment</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    add(<span class="number">1L</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decrement</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    add(-<span class="number">1L</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>取值操作通过sum()来实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">sum</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Cell[] as = cells; Cell a;</span><br><span class="line">    <span class="keyword">long</span> sum = base;</span><br><span class="line">    <span class="keyword">if</span> (as != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; as.length; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((a = as[i]) != <span class="keyword">null</span>)</span><br><span class="line">                sum += a.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>即累加上所有value的值，即为最终的结果。<br>
需要注意的是，同ConcurrentHashMap的size()一样，在取值的时候，并一定是当前的准确值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reset</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Cell[] as = cells; Cell a;</span><br><span class="line">    base = <span class="number">0L</span>;</span><br><span class="line">    <span class="keyword">if</span> (as != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; as.length; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((a = as[i]) != <span class="keyword">null</span>)</span><br><span class="line">                a.value = <span class="number">0L</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过reset操作，将所有value置为0。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">sumThenReset</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Cell[] as = cells; Cell a;</span><br><span class="line">    <span class="keyword">long</span> sum = base;</span><br><span class="line">    base = <span class="number">0L</span>;</span><br><span class="line">    <span class="keyword">if</span> (as != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; as.length; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((a = as[i]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                sum += a.value;</span><br><span class="line">                a.value = <span class="number">0L</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以及拿结果后reset</p>
<h3 id="2-longaccumulator"><a class="header-anchor" href="#2-longaccumulator">¶</a>2.LongAccumulator</h3>
<p>LongAccumulator和LongAdder大同小异，只不过需要指定计算方法以及初始值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LongAccumulator</span><span class="params">(LongBinaryOperator accumulatorFunction,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">long</span> identity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.function = accumulatorFunction;</span><br><span class="line">    base = <span class="keyword">this</span>.identity = identity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而这个accumulatorFunction即为对数值的计算方法，支持各种自定义运算。</p>
<h3 id="3-总结"><a class="header-anchor" href="#3-总结">¶</a>3.总结</h3>
<p>通过对源码的分析，可以看出Doug Lea在对并发做处理的时候，优先考虑简单的更新办法，在当前没有更好的办法的情况下，再做出后续的处理，用空间去换时间。</p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://purplest.github.io/blog/blog/2015/01/21/ByteCode/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="purplest">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一些微小的记录">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/blog/blog/2015/01/21/ByteCode/" class="post-title-link" itemprop="http://purplest.github.io/blog/index.html">ByteCode</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2015-01-21 00:00:00" itemprop="dateCreated datePublished" datetime="2015-01-21T00:00:00+08:00">2015-01-21</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2017-03-30 19:39:42" itemprop="dateModified" datetime="2017-03-30T19:39:42+08:00">2017-03-30</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/blog/categories/architecture/" itemprop="url" rel="index"><span itemprop="name">architecture</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="需求"><a class="header-anchor" href="#需求">¶</a>需求</h3>
<p>之前版本的webentry需要判断每个.class文件（即对应的类上）是否被特定的annotation标记过（比如我们的@controller），若有，则用classloader加载；否则不管。</p>
<h3 id="相关资料"><a class="header-anchor" href="#相关资料">¶</a>相关资料</h3>
<p><a href="https://en.wikipedia.org/wiki/Java_bytecode" target="_blank" rel="noopener">Java byteCode@wiki</a><br>
<a href="http://docs.oracle.com/javase/specs/jvms/se7/html/jvms-4.html" target="_blank" rel="noopener">Class file format@oracle</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ClassFile &#123;</span><br><span class="line">    u4             magic;</span><br><span class="line">    u2             minor_version;</span><br><span class="line">    u2             major_version;</span><br><span class="line">    u2             constant_pool_count;</span><br><span class="line">    cp_info        constant_pool[constant_pool_count-<span class="number">1</span>];</span><br><span class="line">    u2             access_flags;</span><br><span class="line">    u2             this_class;</span><br><span class="line">    u2             super_class;</span><br><span class="line">    u2             interfaces_count;</span><br><span class="line">    u2             interfaces[interfaces_count];</span><br><span class="line">    u2             fields_count;</span><br><span class="line">    field_info     fields[fields_count];</span><br><span class="line">    u2             methods_count;</span><br><span class="line">    method_info    methods[methods_count];</span><br><span class="line">    u2             attributes_count;</span><br><span class="line">    attribute_info attributes[attributes_count];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="方案①"><a class="header-anchor" href="#方案①">¶</a>方案①</h3>
<p>也就是之前采用的方案，用的是spring封装的byteCode reader。该reader是基于ASM的简化版，实现的功能算是比较完善，满足spring的需求。</p>
<p>优点：功能完善，且经过spring的使用，稳定性、兼容性能有保证。<br>
缺点：相对于我们的需求，该reader提供了很多我们实际上用不到的东西，必然要承受的代价就是要慢很多，甚至有可能慢上半个数量级。</p>
<h3 id="方案②"><a class="header-anchor" href="#方案②">¶</a>方案②</h3>
<p>该方法是spring封装的reader的改进版。因为我们的需求非常简单，只需要找到.class（即该类）是否被特定的annotation标记过，那该.class的很多东西都不需要处理，比如fields，methods。因为我们的annotation属于RuntimeVisibleAnnotations，所以只需要在attribute里面去遍历，看是否包含有该annotation即可。</p>
<p>细节：class文件是用流式处理的，严格按照class format格式化的，读取的时候需要顺序读取。比如我们RuntimeVisibleAnnotations，定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">RuntimeVisibleAnnotations_attribute &#123;</span><br><span class="line">    u2         attribute_name_index;</span><br><span class="line">    u4         attribute_length;</span><br><span class="line">    u2         num_annotations;</span><br><span class="line">    annotation annotations[num_annotations];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于每个annotation只能挨着去遍历，并且annotation里边的参数（key-value）也必须挨个读取。<br>
我们的需求里面，不需要在这里处理参数，因此，不用真正的读取，只需要挨着跳过即可。</p>
<p>优点：简化了功能，只保留了我们需要用的功能，在本地测试，能减少50%左右的时间。<br>
缺点：稳定性待验证。</p>
<h3 id="方案③"><a class="header-anchor" href="#方案③">¶</a>方案③</h3>
<p>回顾我们的方案②，经过多次running，可以大概的把cost time分为如下图几部分：</p>
<p>$$<br>
\underbrace{\textrm{total time}}<em>\textrm{142 ms}  \Longrightarrow \begin{cases}<br>
\underbrace{\textrm{part one}}</em>\textrm{86 ms}  \Longrightarrow<br>
\begin{cases}<br>
\underbrace{\textrm{read class(IO)}}<em>\textrm{29 ms} \<br>
\underbrace{\textrm{indexed constant pool}}</em>\textrm{3 ms} \<br>
alloc \ memory \ &amp; \ other<br>
\end{cases}<br>
\<br>
\underbrace{\textrm{part two}}<em>\textrm{61 ms}  \Longrightarrow<br>
\begin{cases}<br>
\underbrace{\textrm{skip method &amp; field}}</em>\textrm{2 ms} \<br>
\underbrace{\textrm{indexed constant pool}}_\textrm{56 ms} \<br>
other<br>
\end{cases}<br>
\end{cases}<br>
$$</p>
<p>回到我们的需求，发现其实我们要的功能很简单，仅仅需要看他是否用了特定的annotation，而不关心更多东西，并且后面用classloader载入该.class。<br>
因为在一个.class文件里，如果该class用到了一个类，那么，在它的constant pool里边一定会有这个类的引用。<br>
所以，在indexed constant pool的时候，我们判断是否有该annotation的引用，如果有该annotation引用，那么很多情况下，这个.class是加上了这个annotation的（从class引用了该annotation，可以推出constant pool里边一定有该类的引用，是一个充分非必要条件，不能反推得出有该类的引用，则引用了该annotation）。</p>
<p>虽然该方案有缺陷，但是因为还有后边的反射做保证，所以，在兼顾性能的情况下，可以再省几近一半的时间，后面的测试也验证了该猜想。</p>
<p>大致的cost time分析：</p>
<p>$$\underbrace{\textrm{total time}}<em>\textrm{70 ms}  \Longrightarrow \begin{cases}<br>
\underbrace{\textrm{read class(IO)}}</em>\textrm{29 ms} \<br>
\underbrace{\textrm{indexed constant pool &amp; judge}}_\textrm{3 ms} \<br>
alloc \ memory \ &amp; \ other<br>
\end{cases}$$</p>
<p>当然，由于hotspot优化，这个时间不是特别的准，仅供参考。</p>
<h3 id="benchmark"><a class="header-anchor" href="#benchmark">¶</a>Benchmark</h3>
<p>三次分别运行的结果</p>
<p>|spring tool Time(方案①)|333ms|319ms|323ms<br>
|normal Time(方案②)|142ms|128ms|124ms<br>
|tiny Time(方案③)|70ms|63ms|60ms<br>
|IO TIme|29ms|25ms|26ms<br>
|normal percentage|42%|40%|38%<br>
|tiny percentage|21%|19%|18%</p>
<h3 id="待继续深入优化的地方"><a class="header-anchor" href="#待继续深入优化的地方">¶</a>待继续深入优化的地方</h3>
<p>首先考虑到的是读写文件，也就是IO的优化。目前用的是FileInputStream，每读一个字符，就会有一个系统调用。并且，现在使用的是把一个.class全部读入内存，并未对4k之类的问题进行考虑。如果将来瓶颈还在这块，可以考虑继续在这里优化。</p>
<h3 id="测试环境"><a class="header-anchor" href="#测试环境">¶</a>测试环境</h3>
<p>将kylin的所有Service（共19个）copy了50次（共953个），放在了同一文件夹下进行的模拟测试。</p>
<p>hotdog的测试结果与kylin的测试结果接近。</p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">purplest</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/blog/archives/">
                
                    <span class="site-state-item-count">9</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">5</span>
                    <span class="site-state-item-name">categories</span>
                  
                </div>
              

              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">purplest</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v6.6.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/blog/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/blog/js/src/utils.js?v=6.6.0"></script>

  <script type="text/javascript" src="/blog/js/src/motion.js?v=6.6.0"></script>



  
  

  

  


  <script type="text/javascript" src="/blog/js/src/bootstrap.js?v=6.6.0"></script>



  



  










  





  

  

  

  

  

  
  

  

  

  

  

  

  

</body>
</html>
